#!/usr/bin/env python3
"""Enforce repository documentation content policies.

This script is intentionally narrow and exists to prevent accidental
re-introduction of stale/generated metadata footers in Markdown docs.
"""

from __future__ import annotations

import sys
from pathlib import Path

SKIP_DIRS = {".deps", ".git", ".pixi", "build", "external", "node_modules"}

# These strings have shown up as "footer metadata" in Markdown docs and should
# not be committed to the repository.
FORBIDDEN_FOOTER_MARKERS = (
    "**Generated**:",
    "**Project Version**:",
    "**Maintainer**:",
    "**Document Generated:**",
    "**DART Version:**",
    "**Analysis Complete**",
)


def iter_markdown_files(repo_root: Path) -> list[Path]:
    files: list[Path] = []
    for path in repo_root.rglob("*.md"):
        if any(part in SKIP_DIRS for part in path.parts):
            continue
        files.append(path)
    return sorted(files)


def check_file(path: Path, repo_root: Path) -> list[str]:
    rel_path = str(path.relative_to(repo_root))
    text = path.read_text(encoding="utf-8", errors="replace")
    lines = text.splitlines()

    failures: list[str] = []

    # Footer marker checks: only scan the tail to avoid false positives in body
    # text (e.g., "generated by X" as part of an explanation).
    tail_len = min(len(lines), 80)
    tail_offset = len(lines) - tail_len
    for index, line in enumerate(lines[tail_offset:], start=tail_offset + 1):
        for marker in FORBIDDEN_FOOTER_MARKERS:
            if marker in line:
                failures.append(f"{rel_path}:{index}: disallowed footer marker {marker!r}")
                break

    return failures


def main() -> int:
    repo_root = Path(__file__).resolve().parent.parent
    failures: list[str] = []
    for path in iter_markdown_files(repo_root):
        failures.extend(check_file(path, repo_root))

    if not failures:
        return 0

    print("Documentation policy check failed:", file=sys.stderr)
    for failure in failures:
        print(f"  - {failure}", file=sys.stderr)
    print(
        "\nRemove footer metadata blocks and affiliation claims from Markdown docs.",
        file=sys.stderr,
    )
    return 1


if __name__ == "__main__":
    raise SystemExit(main())
