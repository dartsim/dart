# DART Header Migration Analysis: PascalCase → snake_case

This document analyzes the DART 6 → DART 8 header file naming transition and records the current implementation.

## Executive Summary

- **Status**: Public headers under `dart/` are now snake_case; PascalCase compatibility headers are generated at build/install time by CMake.
- **Compatibility**: Wrapper generation handles common acronyms (DART/FCL/ODE/IK/IO/IMPL/CAllocator/LcpSolver) and skips case-only wrappers on case-insensitive filesystems to avoid collisions.
- **Remaining**: Top-level umbrella headers `dart/All.hpp` and `dart/Export.hpp` remain PascalCase (case-only) and are candidates for DART 8 cleanup.

## Scope (This PR)

- Renamed public headers in `dart/` (including `detail/` headers) to snake_case.
- Updated internal includes across C++ sources, tests, examples, and Python bindings to use snake_case.
- Removed checked-in PascalCase compat headers; wrappers are generated by CMake during build/install.
- Added a case-insensitive filesystem guard for case-only wrappers.
- Added compat header generation for `dart/lcpsolver` and `LcpSolver` acronym handling.
- Avoided installing the generated `dart/sensor/sensor.hpp` component header to prevent a name collision with the concrete Sensor header.
- Skipped PascalCase wrapper generation for `all.hpp` when it would collide with generated component umbrellas.

Validation: see the `Validation` section.

---

## 1. Current Compatibility Mechanism

### Location

The CMake compat header logic resides in `cmake/dart_defs.cmake`:

| Function                              | Purpose                                                               |
| ------------------------------------- | --------------------------------------------------------------------- |
| `dart_generate_case_compat_headers()` | Generates PascalCase wrapper headers for snake_case source files      |
| `dart_install_compat_headers()`       | Installs generated compat headers preserving directory structure      |
| `dart_generate_component_headers()`   | Generates component umbrellas plus PascalCase wrappers for snake_case |

### How It Works

1. **Detection**: `dart_is_snake_case()` checks if a filename contains no uppercase letters.
2. **Conversion**: `dart_snake_to_pascal()` converts `my_class.hpp` → `MyClass.hpp` and preserves common acronyms.
3. **Generation**: Creates a PascalCase wrapper header containing:
   - Deprecation comment (removal planned for DART 8.0)
   - Cross-compiler deprecation warning (`#pragma message` / `#warning`)
   - Include directive to the actual snake_case header
4. **Case-insensitive guard**: On case-insensitive filesystems, wrapper generation is skipped for case-only renames (no underscore) to avoid collisions.
5. **Installation**: Source snake_case headers and generated PascalCase wrappers are installed together.

### Example Generated Header

```cpp
// Automatically generated backward compatibility header
// This file is DEPRECATED and will be removed in a future release
//
// DEPRECATED: RigidBody.hpp is deprecated.
// Please use rigid_body.hpp instead.
//
// This header will be removed in DART 8.0.

#ifndef DART_SUPPRESS_DEPRECATED_HEADER_WARNING
#if defined(_MSC_VER)
#  pragma message("Warning: RigidBody.hpp is deprecated. Use rigid_body.hpp instead.")
#elif defined(__GNUC__) || defined(__clang__)
#  warning "RigidBody.hpp is deprecated. Use rigid_body.hpp instead."
#endif
#endif // DART_SUPPRESS_DEPRECATED_HEADER_WARNING

#include "dart/simulation/experimental/body/rigid_body.hpp"
```

### Current Usage

The compat mechanism is used across core modules (via `dart_install_compat_headers()`), including:

- `dart/collision/` and `dart/collision/bullet/`, `dart/collision/ode/`
- `dart/common/`
- `dart/constraint/`
- `dart/dynamics/`
- `dart/gui/`
- `dart/io/`
- `dart/lcpsolver/`
- `dart/math/`
- `dart/optimizer/`
- `dart/sensor/`
- `dart/simulation/`
- `dart/utils/`

## 2. Current File Naming State

- **`dart/` public headers**: snake_case (includes `detail/` headers).
- **Umbrella headers**: `dart/All.hpp` and `dart/Export.hpp` remain PascalCase (case-only); plan to revisit in DART 8.
- **`dart/simulation/experimental/`**: snake_case (unchanged).
- **Tests**: Naming conventions unchanged (`test_` + PascalCase for legacy tests).

See `docs/onboarding/code-style.md` for canonical conventions once updated for this migration.

## 3. Assessment: Is the Current Approach Valid?

### Verdict: ✅ YES, with caveats

**Strengths:**

- Follows the industry-standard wrapper header pattern (used by Boost, Qt, etc.).
- Cross-platform deprecation warnings work on MSVC, GCC, and Clang.
- Users can suppress warnings via `DART_SUPPRESS_DEPRECATED_HEADER_WARNING`.
- Preserves backward compatibility during transition.
- Directory structure is maintained in installed headers.
- Centralized generation keeps maintenance low (no checked-in wrappers).
- Build-time overhead is small (simple file writes during CMake configure).
- Packaging stays simple: no reliance on symlinks or platform-specific install tricks.
- Include paths remain deterministic (wrappers always include the snake_case header).

**Caveats:**

- Acronym handling is centralized in `dart_snake_to_pascal()`; new acronym-heavy headers must update the mapping.
- Case-only wrappers are suppressed on case-insensitive filesystems (they still resolve because the FS is case-insensitive).
- Component umbrellas can collide with concrete headers (e.g., `dart/sensor/sensor.hpp`); skip installing the generated umbrella in those cases.
- Warnings can be noisy for downstreams that treat warnings as errors unless they suppress the header warnings.
- Extra wrapper headers increase install footprint and can confuse header discovery tooling.
- Mixed includes (PascalCase and snake_case) can delay cleanup because warnings only fire when legacy headers are included.

## 4. Case-Insensitivity Analysis

### The Problem

On case-insensitive filesystems (macOS default, Windows), `World.hpp` and `world.hpp` are the same path. Installing both can overwrite one with the other.

### Mitigation Used Here

- **Skip wrapper generation for case-only renames** (no underscore) on case-insensitive filesystems.
- **Rely on case-insensitive include resolution**: `#include <dart/World.hpp>` still resolves to `world.hpp` on those systems.
- **Keep wrappers for structural renames** (underscore changes) on all platforms; these do not collide.

### Component Header Collisions

If a component already has a concrete header named `<component>.hpp` (snake_case), the generated `<component>.hpp` umbrella header can collide and create include recursion. In this PR, the `dart/sensor` component skips installing the generated umbrella header to avoid shadowing the concrete `dart/sensor/sensor.hpp`.

## 5. Alternatives Considered

- **Install-time symlinks**: Works well on Unix but is brittle on Windows and some packaging flows; case-only symlinks still collide on case-insensitive filesystems.
- **Install-time copies without warnings**: Reduces noise but hides deprecations, making the migration timeline harder to enforce.
- **Checked-in PascalCase wrappers**: Avoids CMake generation but adds long-term maintenance burden and risks divergence from the canonical headers.
- **Compiler include maps/module maps**: Not portable across toolchains and adds extra build-system complexity.
- **Drop compat immediately**: Maximum churn for downstreams and breaks `gz-physics` users; not acceptable for DART 7.x.

## 6. Recommended Migration Strategy

### DART 7.x (Current)

- Keep snake_case headers as the primary API.
- Generate PascalCase wrappers with deprecation warnings to preserve downstream compatibility.
- Validate gz-physics compatibility with `pixi run -e gazebo test-gz` after each batch.

### DART 8.0 (Clean Break)

- Remove PascalCase compatibility headers entirely.
- Rename the remaining case-only umbrella headers (`dart/All.hpp`, `dart/Export.hpp`).
- Update migration notes and downstream guidance.

## 7. Validation

- `pixi run -e gazebo test-gz` (passed).

## References

- `cmake/dart_defs.cmake` - Compat header generation functions
- `docs/onboarding/code-style.md` - File naming conventions
- `docs/onboarding/release-roadmap.md` - DART 7/8 migration timeline
- `pixi.toml` - `test-gz` task definition
