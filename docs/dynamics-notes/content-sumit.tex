\section{Introduction}

This article attempts to answer the following questions.

\begin{itemize}
\item I know how to derive the equations of motion for one rigid body
  and I have seen people use the following equations for articulated
  rigid bodies, but I don't know how they are derived?
\begin{equation}
M(\vc{q}) \ddot{\vc{q}} + C(\vc{q}, \dot{\vc{q}})  = \vc{Q} \nonumber
\end{equation}

\item I have seen Lagrangian equation in the following form before, but I
  don't know how it is related to the equations of motion above.
\begin{equation}\label{eq:lagrangian_dyn}
    \frac{d}{dt} \left( \frac{\partial \sKinetics_i}{\partial
    \dot{\vJoint}} \right) - \frac{\partial \sKinetics_i}{\partial
    \vJoint} - \vc{Q} = 0 \nonumber
\end{equation}

\item I use generalized coordinates to compute the control forces, how do I convert them to Cartesian forces such that I can use simulators like ODE, PhysX, or Bullet which represent rigid bodies in the maximal coordinates?
\item I heard of Featherstone algorithm. What is it and how is it related to Lagrangian dynamics?
\end{itemize}

\section{Lagrangian Dynamics}
\label{sec:lagrangian}
Articulated human motions can be described by a set of dynamic
equations of motion of multibody systems. Since the direct
application of Newton's second law becomes difficult when a
complex human skeleton is considered, we use \emph{Lagrange's
equations} derived from \emph{D'Alembert's principle} to describe
the dynamic of the motions. The entire human skeleton is consist
of a collection of particles $\{\vGlobalPoint_1, \vGlobalPoint_2,
\ldots, \vGlobalPoint_{\sNumParticle}\}$.  Each particle,
$\vGlobalPoint_i$, is defined by Cartesian coordinates that
describe the translation with respective to the world coordinates.
We can represent $\vGlobalPoint_i$ by a set of \emph{generalized
coordinates} that indicate the joint configuration of the human
skeleton:

\begin{equation}\label{eq:general_coord}
    \vGlobalPoint_i = \vGlobalPoint_i(\sJoint_{1},
\sJoint_{2}, \ldots, \sJoint_{\sNumJoint}, t)
\end{equation}
where $t$ is the time and $\sJoint_j$ is a joint angle value in
the skeleton.

The virtual displacement $\delta \vGlobalPoint_i$ refers to an
infinitesimal change in the system coordinates such that the
constraint remains satisfied. In the context of human skeleton, the
system coordinates are the generalized coordinates $\sJoint_j$ and the
constraint manifold lies in the Cartesian space. The virtual
displacement $\delta \vGlobalPoint_i$ is a tangent vector to the
constraint manifold at a fixed time, written as

\begin{equation}\label{eq:virtual_displace}
    \delta \vGlobalPoint_i = \sum_j \frac{\partial \vGlobalPoint_i}{\partial
    \sJoint_j}\delta \sJoint_j
\end{equation}

We can write virtual work of force $\vForce{i}$ acting on particle
$\vGlobalPoint_i$ as
\begin{equation}\label{eq:virtual_work}
  \vForce{i} \delta \vGlobalPoint_i = \vForce{i} \sum_j \frac{\partial \vGlobalPoint_i}{\partial
    \sJoint_j}\delta \sJoint_j = \sum_j \sGeneralForce{j} \delta \sJoint_j
\end{equation}
where $\sGeneralForce{j}$ is defined as \emph{generalized force}
associated with coordinate $\sJoint_j$.

From D'Alembert's principle, we know that the sum of the differences
between the forces acting on a system and the inertia force of the
system along any virtual displacement consistent with the constraints
of the system, is zero. Therefore, the virtual work at $\vGlobalPoint_i$ can be written as
\begin{equation}\label{eq:inertial_work}
  \delta \sWork_i = \vForce{i} \delta \vGlobalPoint_i = \sInfMass_i \ddot{\vGlobalPoint}_i \cdot
    \delta \vGlobalPoint_i = \sum_j \sInfMass_i \ddot{\vGlobalPoint}_i \cdot
    \frac{\partial \vGlobalPoint_i}{\partial \sJoint_j} \delta \sJoint_j
\end{equation}
where $\sInfMass_i$ is the infinitesimal mass associated with
$\vGlobalPoint_i$. The component of inertia force associated with
$\sJoint_j$ can be written as
\begin{equation}
\label{eq:inertia_force}
  \sInfMass_i \ddot{\vGlobalPoint}_i \cdot \frac{\partial \vGlobalPoint_i}{\partial \sJoint_j} =
  \frac{d}{dt} \left( \sInfMass_i \dot{\vGlobalPoint}_i \cdot \frac{\partial
  \vGlobalPoint_i}{\partial \sJoint_j} \right) - \sInfMass_i
\dot{\vGlobalPoint}_i \cdot \frac{d}{dt} \left( \frac{\partial
    \vGlobalPoint_i}{\partial \sJoint_j} \right) 
\end{equation}

Now let us consider the velocity of $\vGlobalPoint_i$ in terms of
joint velocity $\dot{\sJoint}_j$
\begin{equation}
\label{eq:velocity}
\dot{\vGlobalPoint}_i = \sum_j \frac{\partial
  \vGlobalPoint_i}{\partial \sJoint_j} \dot{\sJoint}_j
\end{equation}
from which we derive the following two identities:
\begin{eqnarray}
\frac{\partial \dot{\vGlobalPoint}_i}{\partial \dot{\sJoint}_j} &=&
\frac{\partial \vGlobalPoint_i}{\partial \sJoint_j}  \\
\frac{\partial \dot{\vGlobalPoint}_i}{\partial \sJoint_j} &=&
\sum_k \frac{\partial^2 \vGlobalPoint_i}{\partial \sJoint_j \partial
  \sJoint_k} \dot{\sJoint}_k = \frac{d}{dt} \frac{\partial \vGlobalPoint_i}{\partial \sJoint_j}
\end{eqnarray}

Using these two identities, we rewrite Equation \ref{eq:inertia_force} as
\begin{equation}
\label{eq:inertia_force2}
\sInfMass_i \ddot{\vGlobalPoint}_i \cdot \frac{\partial \vGlobalPoint_i}{\partial \sJoint_j}   = \frac{d}{dt} \left[ \frac{\partial}{\partial \dot{\sJoint}_j} \left( \frac{1}{2} \sInfMass_i \dot{\vGlobalPoint}_i^{T} \dot{\vGlobalPoint}_i\right) \right]
   - \frac{\partial}{\partial \sJoint_j} \left( \frac{1}{2} \sInfMass_i \dot{\vGlobalPoint}_i^{T} \dot{\vGlobalPoint}_i \right)
\end{equation}

We can denote the kinetic energy of $\vGlobalPoint_i$ as
\begin{equation}\label{eq:kinetic_energy}
    \sKinetics_i = \frac{1}{2} \sInfMass \dot{\vGlobalPoint}_i^{T}
    \dot{\vGlobalPoint}_i,
\end{equation}
and rewrite Equation \ref{eq:inertia_force2} as
\begin{equation}\label{eq:inertia_kinetic}
    \sInfMass_i \ddot{\vGlobalPoint}_i \cdot \frac{\partial \vGlobalPoint_i}{\partial
    \sJoint_j} = \frac{d}{dt} \left( \frac{\partial \sKinetics_i}{\partial
    \dot{\sJoint}_j}\right) - \frac{\partial \sKinetics_i}{\partial \sJoint_j}
\end{equation}

Combining the definition of generalized force (Equation
\ref{eq:virtual_work}), D'Alembert's principle (Equation
\ref{eq:inertial_work}), and the generalized inertia force (Equation
\ref{eq:inertia_kinetic}), we arrive at the following equation:
\begin{equation}\label{eq:dynamic_equil}
    \left[ \frac{d}{dt} \left( \frac{\partial \sKinetics_i}{\partial \dot{\sJoint}_j} \right) - \frac{\partial \sKinetics_i}{\partial
    \sJoint_j}\right] \delta \sJoint_j = \sGeneralForce{j} \delta
    \sJoint_j
\end{equation}

If the set of generalized coordinates $\sJoint_j$ is linearly
independent, Equation \ref{eq:dynamic_equil} leads to
\emph{Lagrangian equation}:
\begin{equation}\label{eq:lagrangian_dyn2}
    \frac{d}{dt} \left( \frac{\partial \sKinetics_i}{\partial
    \dot{\sJoint}_j} \right) - \frac{\partial \sKinetics_i}{\partial
    \sJoint_j} - \sGeneralForce{j} = 0
\end{equation}

\paragraph{Equations of Motion in Vector Form.} Equation
\ref{eq:lagrangian_dyn2} is the equation of motion for one generalized coordinate in a
multibody system. We can combine $\sNumJoint$  scalar equations into
the familiar vector form
\begin{equation}\label{eq:lagrangian_vector}
M(\vc{q}) \ddot{\vc{q}} + C(\vc{q}, \dot{\vc{q}}) = \vc{Q} 
\end{equation}
where $M(\vc{q})$ is the mass matrix, $C(\vc{q}, \dot{\vc{q}})$ is the
Coriolis and centrifugal term of the equation of motion, and $\vc{Q}$
is the vector of generalized forces for all the degrees of freedom
(DOFs) in the system. $M$ only depends on $\vc{q}$ and $C$ depends
quadratically on $\dot{\vc{q}}$.

How do we derive $M$ and $C$ from Equation \ref{eq:lagrangian_dyn2}?
Let us go back to the velocity of one particle $\vGlobalPoint_i$:
\begin{equation}
\dot{\vGlobalPoint}_i = \sum_j \frac{\partial
  \vGlobalPoint_i}{\partial \sJoint_j} \dot{\sJoint}_j = J_i(\vc{q}) \dot{\vc{q}}
\end{equation}
where $J_i$ denotes the Jacobian of $\vGlobalPoint_i$. By summing up
all the particles in the system, the kinetic
energy of the system can then be expressed as
\begin{equation}
\label{eq:kinetic_vector}
T = \sum_i T_i = \sum_i \frac{1}{2}  \sInfMass \dot{\vGlobalPoint}_i^{T}
    \dot{\vGlobalPoint}_i = \sum_i \frac{1}{2}  \sInfMass (J_i
    \dot{\vc{q}})^T(J_i \dot{\vc{q}}) = \frac{1}{2} \dot{\vc{q}}^T
    (\sum_i \sInfMass J_i^TJ_i) \dot{\vc{q}} = \frac{1}{2}
    \dot{\vc{q}}^T M(\vc{q}) \dot{\vc{q}}
\end{equation}
where we define the mass matrix, $M(\vc{q}) = \sum_i \sInfMass
J_i^TJ_i$, and will shortly show it is indeed the mass matrix in
Equation \ref{eq:lagrangian_vector}.

From Equation \ref{eq:kinetic_vector}, we can derive the derivative
terms to construct the Lagrange's equation (Equation
\ref{eq:lagrangian_dyn2}).
\begin{equation}
\frac{d}{dt}\frac{\partial T}{\partial \dot{\vc{q}}} - \frac{\partial
  T}{\partial \vc{q}} = M\ddot{\vc{q}} + \dot{M} \dot{\vc{q}} - \frac{1}{2}\dot{\vc{q}}^T \frac{\partial M}{\partial \vc{q}} \dot{\vc{q}} = M
\ddot{\vc{q}} + C(\vc{q}, \dot{\vc{q}})
\end{equation}
where $C$ is the Coriolis and centrifugal term in Equation
\ref{eq:lagrangian_vector} and is defined as $C = \dot{M}
\dot{\vc{q}} - \frac{1}{2}\dot{\vc{q}}^T \frac{\partial M}{\partial
  \vc{q}} \dot{\vc{q}}$. 
 \ignorethis{Note that the second term of $C$ involves a
tensor multiplication so that $\frac{\partial M}{\partial
  \vc{q}} \dot{\vc{q}}$ is not equivalent to $\dot{M}$.
  }
\paragraph{Note.} In the second term of $C$, we introduce tensor notation $\frac{\partial M}{\partial \vc{q}}$, which implies that the $j^{th}$ element of the tensor $\frac{\partial M}{\partial \vc{q}}$ is the matrix $\frac{\partial M}{\partial {q}_j}$. Note that the quantity with notation $\frac{\partial M}{\partial \vc{q}} \dot{\vc{q}}$ is \textbf{\emph{not}} equal to $\dot{M}$. This is because, the $j^{th}$ column of the matrix $\frac{\partial M}{\partial \vc{q}} \dot{\vc{q}}$ is the vector $\frac{\partial M}{\partial q_j} \dot{\vc{q}}$ or $\sum_k \frac{\partial (M)_k}{\partial q_j} \dot{{q}_k}$, where the notation $(A)_j$ denotes the $j^{th}$ column of the matrix $A$. In contrast, the $j^{th}$ column of the matrix $\dot{M}$ is $\sum_k \frac{\partial (M)_j}{\partial q_k} \dot{{q}_k}$.

Once we know how to compute the mass matrix, Coriolis and centrifugal
term, and generalized forces, we can compute the acceleration in
generalized coordinates, $\ddot{\vc{q}}$, for forward
simulation. Conversely, if we are given $\ddot{\vc{q}}$ from a motion
sequence, we can use these equations of motion to derive generalized
forces for inverse dynamics. 

\sumit{say it is tedious to do it for rigid bodies since infinite number of points. We make use of the fact that points in a single rigid body satisfy a compact relation etc.}

\section{Rigid Body Dynamics: Newton-Euler equations}
We describe the familiar Newton-Euler equations of rigid body dynamics. We start writing down the
momenta of the rigid body whose mass, position of the center
of mass (COM), orientation,
linear velocity of the COM, and angular velocity are $m$, $\vc{x}$, $R$,
$\vc{v}$, and $\bm{\omega}$ respectively (same as defined in Witkin and
Baraff's course notes). The linear momentum \vc{p} is computed as:
\begin{eqnarray}
\vc{P} &=& \sum_i \vc{p}_i = \sum_i \sInfMass \dot{\vGlobalPoint}_i = \sum_i  \sInfMass (\vc{v} + \bm{\omega}
    \times \vc{r}_i') \nonumber \\
 &=& m \vc{v}
\end{eqnarray}
where $\vc{r}_i' = \vc{r}_i - \vc{x}$. Because $\sum_i \sInfMass
\vc{r}_i' = \vc{0}$, the second term vanishes. The angular momentum \vc{L} about the COM is computed as:
\begin{eqnarray}
\nonumber
\vc{L} & = & \sum_i \vc{l}_i  = \sum_i \vc{r}_i' \times \vc{p}_i\\
\nonumber
& = & \sum_i \sInfMass \vc{r}_i' \times (\vc{v} + \bm{\omega} \times \vc{r}_i')\\
&= & \vc{0} + \sum_i \sInfMass [\vc{r}_i'][\bm{\omega}]\vc{r}_i' = \left ( \sum_i -\sInfMass [\vc{r}_i'][\vc{r}_i'] \right )\bm{\omega}
\end{eqnarray}
Note that we used the identity $[\vc{a}]\vc{b} = -[\vc{b}]\vc{a}$. 
Now recall the inertia tensor about the COM defined in Witkin and
Baraff's course notes: $I_c = \sum_i \sInfMass ((\vc{r}_i'^T
\vc{r}_i')\vc{I} - \vc{r}_i' \vc{r}_i'^T)$, where $\vc{I}$ is the
identity matrix. We can easily show that
$I_c = \sum_i -\sInfMass [\vc{r}_i'][\vc{r}_i']$ by verifying the
identity $-[\vc{a}][\vc{a}] = (\vc{a}^T\vc{a}) \vc{I}  -
\vc{a}\vc{a}^T$. As a result, we write the angular momentum of a rigid body as:
\begin{equation}
\vc{L} = I_c \bm{\omega}
\end{equation}
Note that the inertia tensor can be written as $I_c = RI_0R^T$, where $R$ is the rotation matrix corresponding to the orientation of the body and $I_0$ is the constant inertia tensor defined at zero rotation. The angular velocity in the skew-symmetric form is related to the rotation matrix $R$ as $[\bm{\omega}] = \dot{R}R^T$. Also $[\bm{\omega}]^T = -[\bm{\omega}]$.

Now, the dynamics of a rigid body can be written as $\vc{f} = \dot{\vc{P}} \mbox{,\ } \bm{\tau} = \dot{\vc{L}}$. The equations corresponding to the linear force can be evaluated as:
\begin{eqnarray}
\label{eq:force}
\vc{f} & = & \dot{\vc{P}} = m \dot{\vc{v}}
\end{eqnarray}
The equations corresponding to the torque can be evaluated as:
\begin{eqnarray}
\label{eq:torque}
\nonumber
\bm{\tau} & = & \dot{\vc{L}} = \dot{(I_c \bm{\omega})} \\
\nonumber
& = & I_c\dot{\bm{\omega}} + \dot{(RI_0 R^T)}\bm{\omega} = I_c\dot{\bm{\omega}} + \dot{R}I_0 R^T\bm{\omega} + R I_0 \dot{R}^T\bm{\omega}\\
\nonumber
& = & I_c\dot{\bm{\omega}} + \dot{R}R^T I_c \bm{\omega} + I_c (\dot{R}R^T)^T\bm{\omega} \\
& = & I_c\dot{\bm{\omega}} + [\bm{\omega}]I_c \bm{\omega} - I_c[\bm{\omega}]\bm{\omega} = I_c\dot{\bm{\omega}} + \bm{\omega} \times I_c \bm{\omega}
\end{eqnarray}

Combining \eqnref{force} and \eqnref{torque}, we get:
\begin{equation}
\left(
\begin{array}{cc}
m\vc{I} & \vc{0} \\
\vc{0} & I_c 
\end{array}
\right)
\left(
\begin{array}{c}
\dot{\vc{v}} \\
\dot{\bm{\omega}} 
\end{array}
\right) +
\left(
\begin{array}{c}
\vc{0}  \\
\bm{\omega} \times I_c \bm{\omega} 
\end{array}
\right) = 
\left(
\begin{array}{c}
\vc{f} \\
\bm{\tau} 
\end{array}
\right)
\end{equation}

\section{Rigid Body Dynamics: Generalized coordinates}
\label{sec:rigidbodydyngen}
The Newton-Euler equations are defined in terms of velocities instead of position and orientation. We now derive the equations in generalized coordinates \vc{q} that define the position and orientation. The first three coordinates are the same as the position of COM. The next three represent the rotation of the rigid body such as an exponential map or three Euler angles (or four coordinates can be used for a quaternion).

We first start by computing the kinetic energy of the rigid body:
\begin{eqnarray}
\label{eq:rigid_kinetic}
T &=& \sum_i T_i = \sum_i \frac{1}{2}  \sInfMass \dot{\vGlobalPoint}_i^{T}
    \dot{\vGlobalPoint}_i = \sum_i \frac{1}{2}  \sInfMass (\vc{v} + \bm{\omega}
    \times \vc{r}_i')^T (\vc{v} + \boldsymbol{\bm{\omega}}
    \times \vc{r}_i') \nonumber \\
 &=& \sum_i \frac{1}{2}  \sInfMass (\vc{v}^T\vc{v} +
    \vc{v}^T [\bm{\omega}] \vc{r}_i' + \vc{r}_i'^T [\bm{\omega}]^T \vc{v} +
    \vc{r}_i'^T [\bm{\omega}]^T [\bm{\omega}] \vc{r}_i')
\end{eqnarray}
Because $\sum_i \sInfMass
\vc{r}_i' = \vc{0}$, the second term and the third term in \eqnref{rigid_kinetic} vanish. Using the identity $[\bm{\omega}]\vc{r}_i' =
-[\vc{r}_i']\bm{\omega}$, we can rewrite \eqnref{rigid_kinetic}
as:
\begin{eqnarray}
\nonumber
T & = & \frac{1}{2} m \vc{v}^T\vc{v} + \frac{1}{2} \bm{\omega}^T \left ( \sum_i -\sInfMass
 [\vc{r}_i'][\vc{r}_i'] \right ) \bm{\omega}\\
 & = & \frac{1}{2} m \vc{v}^T\vc{v} + \frac{1}{2} \bm{\omega}^T I_c \bm{\omega}
\end{eqnarray}
The kinetic energy of a rigid body can be written in its vector form:
\begin{eqnarray}
\label{eq:kinetic_vec}
T &=& \frac{1}{2} (\vc{v}^T \;\; \bm{\omega}^T)
\left(
\begin{array}{cc}
m\vc{I} & \vc{0} \\
\vc{0} & I_c
\end{array}
\right)
\left(
\begin{array}{c}
\vc{v} \\
\bm{\omega} 
\end{array}
\right)
 \equiv \frac{1}{2}\vc{V}^T M_c \vc{V}
\end{eqnarray}
where $\vc{V} \equiv (\vc{v}^T,\bm{\omega}^T)^T$, $M_c \equiv \mbox{blockdiag}(m\vc{I},I_c)$ and $\vc{I}$ is a $3\times3$ identity matrix. We now relate the velocities in the Cartesian space $\vc{V}$ to the generalized velocities $\dot{\vc{q}}$. Let $\vc{c}(\vc{q})$ and $R(\vc{q})$ represent the position of the COM and the rotation matrix of the rigid body. The linear velocity of the COM is computed as:
\begin{eqnarray}
\label{eq:vellin}
\vc{v} \equiv \dot{\vc{c}}(\vc{q}) = \frac{\partial \vc{c}}{\partial \vc{q}} \dot{\vc{q}} \equiv J_v \dot{\vc{q}}
\end{eqnarray}
The angular velocity is computed as:
\begin{eqnarray}
\nonumber
[\bm{\omega}] & \equiv & \dot{R}(\vc{q})R^T(\vc{q}) \\
\label{eq:Jaccolj}
& = & \sum_j \frac{\partial R}{\partial q_j}R^T \dot{q}_j \equiv \sum_j [\vc{j}_{j}] \dot{q}_j
\end{eqnarray}
$\frac{\partial R}{\partial q_j}R^T$ is always a skew-symmetric matrix that we represent as $[\vc{j}_{j}]$ (skew-symmetric form of the vector $\vc{j}_j$). $\bm{\omega}$ can be now be represented in the vector form as:
\begin{equation}
\label{eq:velang}
\bm{\omega} = J_{\omega} \dot{\vc{q}}
\end{equation}
where $\vc{j}_{j}$ is the $j^{th}$ column of the matrix $J_{\omega}$.

Using \eqnref{vellin} and \eqnref{velang}, we can write:
\begin{equation}
\vc{V} = \left(
\begin{array}{c}
J_v \\
J_{\omega}
\end{array}
\right) \dot{\vc{q}} \equiv J(\vc{q})\dot{\vc{q}}
\end{equation}
Substituting the above in \eqnref{kinetic_vec}, we get:
\begin{equation}
T = \frac{1}{2}\dot{\vc{q}}^T J^T M_c J \dot{\vc{q}}
\end{equation}

Using the recipe of Lagrangian dynamics in \eqnref{lagrangian_dyn2}, we first compute $\frac{\partial T}{\partial \dot{q}_j}$ as:
\begin{eqnarray}
\nonumber
\frac{\partial T}{\partial \dot{q}_j} & = & \frac{1}{2}\dot{\vc{q}}^T J^T M_c (J)_j + \frac{1}{2} (J)_j^T M_c J \dot{\vc{q}}\\
 & = & (J)_j^T M_c J \dot{\vc{q}}
\end{eqnarray}
where the notation $(A)_j$ denotes the $j^{th}$ column of the matrix A. The term $\frac{d}{dt} \left( \frac{\partial T}{\partial \dot{q}_j} \right )$ is computed as:
\begin{eqnarray}
\label{eq:lagterm1}
\frac{d}{dt} \left ( \frac{\partial T}{\partial \dot{q}_j} \right ) & = & (J)_j^T M_c J \ddot{\vc{q}} + (J)_j^T M_c \dot{J} \dot{\vc{q}} + (J)_j^T \dot{M}_c J \dot{\vc{q}} + \dot{(J)}_j^T M_c J \dot{\vc{q}}
\end{eqnarray}
Now we evaluate the term $\frac{\partial T}{\partial q_j}$:
\begin{eqnarray}
\nonumber
\frac{\partial T}{\partial q_j} & = & \frac{1}{2}\dot{\vc{q}}^T J^T M_c \frac{\partial J}{\partial q_j} \dot{\vc{q}} + \frac{1}{2}\dot{\vc{q}}^T J^T \frac{\partial M_c}{\partial q_j} J \dot{\vc{q}} + \frac{1}{2}\dot{\vc{q}}^T \frac{\partial J^T}{\partial q_j} M_c J \dot{\vc{q}}\\
\label{eq:lagterm2}
& = & \dot{\vc{q}}^T \frac{\partial J^T}{\partial q_j} M_c J \dot{\vc{q}} + \frac{1}{2}\dot{\vc{q}}^T J^T \frac{\partial M_c}{\partial q_j} J \dot{\vc{q}}
\end{eqnarray}
Using the above equations, we write:
\begin{eqnarray}
\label{eq:lageqn_j}
\nonumber
\frac{d}{dt} \left ( \frac{\partial T}{\partial \dot{q}_j} \right ) - \frac{\partial T}{\partial q_j} & = & (J)_j^T M_c J \ddot{\vc{q}} + (J)_j^T M_c \dot{J} \dot{\vc{q}} + (J)_j^T \dot{M}_c J \dot{\vc{q}} - \frac{1}{2}\dot{\vc{q}}^T J^T \frac{\partial M_c}{\partial q_j} J \dot{\vc{q}} \\ & & + \left ( \dot{(J)}_j^T M_c J \dot{\vc{q}}  - \left( \frac{\partial J}{\partial q_j} \dot{\vc{q}}\right)^T M_c J \dot{\vc{q}} \right )
\end{eqnarray}

The second term in the above equation involves the computation of $\dot{J}$ that can be computed as $\sum_k \frac{\partial J}{\partial q_k} \dot{q}_k$. We now simplify the third, fourth and the fifth terms one by one. Let us start with the third term:
\begin{eqnarray}
\label{eq:term3}
\nonumber
(J)_j^T \dot{M}_c J \dot{\vc{q}} & = & (J_w)_j^T \dot{I}_c J_w \dot{\vc{q}} \mbox{\ \ (Reduced using the definition of $M_c$ in \eqnref{kinetic_vec})}\\
\nonumber
& = & \vc{j}_j^T\dot{(RI_0 R^T)}\bm{\omega} \mbox{\ \ ($\vc{j}_j$ represents the $j^{th}$ column of $J_w$: see \eqnref{Jaccolj})} \\
\mbox{term 3} & = & \vc{j}_j^T[\bm{\omega}]I_c \bm{\omega}  \mbox{\ \ (From \eqnref{torque})}
\end{eqnarray}
The fourth term in \eqnref{lageqn_j} can be simplified as:
\begin{eqnarray}
\label{eq:term4}
\nonumber
\frac{1}{2}\dot{\vc{q}}^T J^T \frac{\partial M_c}{\partial q_j} J \dot{\vc{q}} & = & \frac{1}{2} (J_w \dot{\vc{q}})^T \frac{\partial I_c}{\partial q_j} J_w \dot{\vc{q}}\\
\nonumber
& = & \frac{1}{2} \bm{\omega}^T \left ( \frac{\partial R}{\partial q_j}I_0R^T + RI_0\frac{\partial R^T}{\partial q_j} \right )  \bm{\omega} = \bm{\omega}^T \left ( \frac{\partial R}{\partial q_j}I_0R^T \right ) \bm{\omega} \\
\nonumber
& = & \bm{\omega}^T \left ( \frac{\partial R}{\partial q_j}R^T I_c \right ) \bm{\omega}\\
\nonumber
 & = & \bm{\omega}^T [\vc{j}_j] I_c \bm{\omega} \mbox{\ \ (From \eqnref{Jaccolj})}\\
\mbox{term 4}  & = & - \vc{j}_j^T[\bm{\omega}]I_c \bm{\omega} \mbox{\ \ (Using the identity $\vc{a}.(\vc{b}\times\vc{c}) = -\vc{b}.(\vc{a}\times\vc{c}))$}
\end{eqnarray}
For simplifying the fifth term in \eqnref{lageqn_j}, we explicitly express it using the linear and angular components:
\begin{eqnarray}
\label{eq:term5}
\left (
\begin{array}{cc}
\dot{(J_v)_j}^T & \dot{(J_\omega)_j}^T
\end{array} 
\right )
\left(
\begin{array}{cc}
m\vc{I} & \vc{0} \\
\vc{0} & I_c
\end{array}
\right)
\left (
\begin{array}{cc}
J_v \dot{\vc{q}} \\
J_\omega \dot{\vc{q}}
\end{array} 
\right )
-
\left (
\begin{array}{cc}
\left(\frac{\partial J_v}{\partial q_j}\dot{\vc{q}}\right)^T & \left(\frac{\partial J_\omega}{\partial q_j}\dot{\vc{q}}\right)^T
\end{array} 
\right )
\left(
\begin{array}{cc}
m\vc{I} & \vc{0} \\
\vc{0} & I_c
\end{array}
\right)
\left (
\begin{array}{cc}
J_v \dot{\vc{q}} \\
J_\omega \dot{\vc{q}}
\end{array} 
\right )
\end{eqnarray}
The linear term can be extracted and simplified as:
\begin{eqnarray}
\label{eq:term5_lin}
\nonumber
m\left( \dot{(J_v)_j}  - \left(\frac{\partial J_v}{\partial q_j}\dot{\vc{q}}\right) \right )^T J_v \dot{\vc{q}} & = & m\left( \sum_k \frac{\partial (J_v)_j}{\partial q_k}\dot{q}_k -  \sum_k \frac{\partial (J_v)_k}{\partial q_j} \dot{q}_k \right )^T J_v \dot{\vc{q}}\\
\nonumber
& = & m\left( \sum_k \frac{\partial^2 \vc{c}}{\partial q_j \partial q_k}\dot{q}_k -  \sum_k \frac{\partial^2 \vc{c}}{\partial q_k \partial q_j} \dot{q}_k \right )^T J_v \dot{\vc{q}} \\
\mbox{term 5 (linear)} & = & 0
\end{eqnarray}
The above derivation uses the property of the Jacobian of the linear velocity  $(J_v)_j = \frac{\partial \vc{c}}{\partial q_j}$ $\forall j$ (See \eqnref{vellin}).

We now extract and simplify the angular term in \eqnref{term5} as:
\begin{eqnarray}
\label{eq:term5_ang}
\nonumber
\left( \dot{(J_\omega)_j}  - \left(\frac{\partial J_\omega}{\partial q_j}\dot{\vc{q}}\right) \right )^T I_c J_\omega \dot{\vc{q}} & = & \left( \sum_k \frac{\partial \vc{j}_j}{\partial q_k}\dot{q}_k -  \sum_k \frac{\partial \vc{j}_k}{\partial q_j} \dot{q}_k \right )^T I_c \bm{\omega}\\
& = & \left( \sum_k \left ( \frac{\partial \vc{j}_j}{\partial q_k}  -  \frac{\partial \vc{j}_k}{\partial q_j}\right ) \dot{q}_k \right )^T I_c \bm{\omega} \equiv \left ( \sum_k \vc{z}_{jk} \dot{q}_k \right )^T I_c\bm{\omega} 
\end{eqnarray}
Now let us evaluate the term denoted by $\vc{z}_{jk}$. Consider the skew symmetric form:
\begin{eqnarray}
\nonumber
[\vc{z}_{jk}] & = & \left [ \frac{\partial \vc{j}_j}{\partial q_k}  -  \frac{\partial \vc{j}_k}{\partial q_j} \right ] = \frac{\partial [\vc{j}_j]}{\partial q_k}  -  \frac{\partial [\vc{j}_k]}{\partial q_j}\\
\nonumber
& = & \left ( \frac{\partial^2 R}{\partial q_j \partial q_k} + \frac{\partial R}{\partial q_j} \frac{\partial R^T}{\partial q_k} \right ) - \left ( \frac{\partial^2 R}{\partial q_k \partial q_j} + \frac{\partial R}{\partial q_k} \frac{\partial R^T}{\partial q_j} \right ) \mbox{\ \ (From \eqnref{Jaccolj})}\\
\nonumber
& = & \frac{\partial R}{\partial q_j}R^T \left( \frac{\partial R}{\partial q_k}R^T\right)^T - \frac{\partial R}{\partial q_k}R^T \left( \frac{\partial R}{\partial q_j}R^T\right)^T\\
\nonumber
& = & -[\vc{j}_j][\vc{j}_k] + [\vc{j}_k][\vc{j}_j] \mbox{\ \ (Using the identity $[\vc{a}]^T = -[\vc{a}]$)}\\
\nonumber
& = & [\vc{j}_k\times \vc{j}_j] \mbox{\ \ (Using the identity $[\vc{u}\times \vc{v}] = [\vc{u}][\vc{v}] - [\vc{v}][\vc{u}]$)}\\
\Rightarrow \vc{z}_{jk} & = & \vc{j}_k\times \vc{j}_j = [\vc{j}_k] \vc{j}_j
\end{eqnarray}

Substituting the above in \eqnref{term5_ang}, we get:
\begin{eqnarray}
\label{eq:term5_ang_final}
\nonumber
\left ( \sum_k \vc{z}_{jk} \dot{q}_k \right )^T I_c\bm{\omega}  & = & \left ( \sum_k [\vc{j}_k] \vc{j}_j \dot{q}_k \right )^T I_c\bm{\omega} \\
\nonumber
& = & \left ( \bigg ( \sum_k [\vc{j}_k]\dot{q}_k \bigg ) \vc{j}_j \right )^T I_c\bm{\omega}\\
\nonumber
& = & \left ( \bigg [ \sum_k \vc{j}_k \dot{q}_k \bigg ] \vc{j}_j \right )^T I_c\bm{\omega} \mbox{\ \ (Using linearity of the cross product)}\\
\nonumber
& = & \left ( [ J_\omega \dot{\vc{q}} ] \vc{j}_j \right )^T I_c\bm{\omega} = ([\bm{\omega}]\vc{j}_j)^TI_c\bm{\omega}\\
\mbox{term 5 (angular)} & = & -\vc{j}_j^T [\bm{\omega}] I_c\bm{\omega}
\end{eqnarray} 

Finally, we substitute the terms computed in \eqnref{term3}, \eqnref{term4}, \eqnref{term5_lin} and \eqnref{term5_ang_final} into \eqnref{lageqn_j} and rewrite it as:
\begin{eqnarray}
\label{eq:lageqn_j_final}
\nonumber
\frac{d}{dt} \left ( \frac{\partial T}{\partial \dot{q}_j} \right ) - \frac{\partial T}{\partial q_j} & = & (J)_j^T M_c J \ddot{\vc{q}} + (J)_j^T M_c \dot{J} \dot{\vc{q}} + \vc{j}_j^T[\bm{\omega}]I_c \bm{\omega}\\
\nonumber
& = & \left( (J)_j^T M_c J \right )\ddot{\vc{q}} + \left( (J)_j^T M_c \dot{J} + (J)_j^T [\tilde{\bm{\omega}}]M_c J \right )\dot{\vc{q}}\\
\mbox{where } [\tilde{\bm{\omega}}] & = &
\left ( 
\begin{array}{cc}
\vc{0} & \vc{0} \\
\vc{0} & [J_\omega \dot{\vc{q}}]
\end{array}
\right )
\end{eqnarray}

Writing the equations for all the $q_j$ in the vector form, we get:
\begin{eqnarray}
\label{eq:dyngen_vec}
\frac{d}{dt} \left ( \frac{\partial T}{\partial \dot{\vc{q}}} \right ) - \frac{\partial T}{\partial \vc{q}} & = & \left( J^T M_c J \right )\ddot{\vc{q}} + \left( J^T M_c \dot{J} + J^T [\tilde{\bm{\omega}}]M_c J \right )\dot{\vc{q}}
\end{eqnarray}

\ignorethis{
\paragraph{Note.}
In the above equation, we introduce tensor notations $\frac{\partial J}{\partial \vc{q}}$ and $\frac{\partial M_c}{\partial \vc{q}}$. For example, $j^{th}$ element of the tensor $\frac{\partial J}{\partial \vc{q}}$ is the matrix $\frac{\partial J}{\partial {q}_j}$. Note that the notation $\frac{\partial J}{\partial \vc{q}} \dot{\vc{q}}$ is \emph{not} the same as $\dot{J}$. This is because, the $j^{th}$ column of the matrix $\frac{\partial J}{\partial \vc{q}} \dot{\vc{q}}$ is the vector $\frac{\partial J}{\partial q_j} \dot{\vc{q}}$ or $\sum_k \frac{\partial (J)_k}{\partial q_j} \dot{{q}_k}$. In contrast, the $j^{th}$ column of the matrix $\dot{J}$ is $\sum_k \frac{\partial (J)_j}{\partial q_k} \dot{{q}_k}$. To avoid any confusion, we explicitly represent $\dot{J}$ as $\sum_k \frac{\partial J}{\partial q_k} \dot{q}_k$.
}

\section{Articulated Rigid Body Dynamics}
We now derive the equations of motion for an articulated rigid body structure. We follow the derivation of rigid body dynamics in generalized coordinates from \secref{rigidbodydyngen}.

An articulated rigid body system is represented as a set of rigid bodies connected through joints in a tree structure. The generalized coordinates are the six DOFs representing the global translation and rotation of the root link of the tree, and the joint angles corresponding to the admissible joint rotations for all the joints. 

\subsection{Definitions}
The state of an articulated rigid body
system can be expressed as $(\vc{x}_k, R_k, \vc{v}_k,
\boldsymbol{\bm{\omega}}_k)$, where $k = 1, \cdots, m$ and $m$ is the number of rigid links. Here $\vc{x}_k$ and
$R_k$ are the position and orientation of the rigid link $k$, and $(\vc{v}_k,
{\bm{\omega}}_k)$ are the linear and angular velocity of the
rigid link $k$ viewed in the world frame. Similarly, we define the
Cartesian force and torque applied on rigid link $k$ as $(\vc{f}_k,
{\tau}_k)$, both of which are expressed in the world
frame.

The same articulated rigid body system can be represented in
generalized coordinates. We define the generalized state as $(q_j,
\dot{q}_j)$, where $j = 1, \cdots, n$.

\subsection{Cartesian and Generalized velocities}
We now describe how to express the Cartesian velocities in terms of generalized velocities for the articulated body system. 
For a single rigid body, \eqnref{velang} describes the relation between the velocities as $[\bm{\omega}] = J_{\omega} \dot{\vc{q}}$,
where each column $\vc{j}_j$ of the Jacobian matrix $J_{\omega}$ is defined as:
\begin{equation}
[\vc{j}_j] = \frac{\partial R}{\partial q_j} R^T
\end{equation}

\begin{wrapfigure}{r}{0.4\textwidth}
 \vspace{-10pt}
\begin{center}
\includegraphics[width=2.1in]{example1.eps}
\end{center}
\caption{An articulated system.}
 \vspace{-20pt}
\label{fig:example1}
\end{wrapfigure}

Now, consider a multibody system with $m$ rigid links. Before we look
at its angular velocity, let us first define a few notations.
\begin{itemize}
\item $s(k)$ returns the index set of DOFs in link $k$, and $s(1, k)$
  returns the index set of DOFs in the chain of links from the root to
  the link $k$. For example in Figure \ref{fig:example1}, $s(2) = \{3, 4, 5\}$, $s(1, 4) = \{1, 2, 3,
    4, 5, 7\}$.
\item $p(k)$ returns the index of the parent link of link $k$. For
  example, $p(4) = 2$.
\item $l(j)$ returns the link index where DOF $j$ resides. For
  example, $l(5) = 2$.
\item $R^0_k$ is the chain of rotational transformations from the
  world frame to the local frame of the link $k$.
\end{itemize}

The angular velocity of link $k$ viewed in the world frame is then
\begin{eqnarray}
[\bm{\omega}_k] & = & \dot{(R^0_{p(k)}R_k)} (R^0_{p(k)}R_k)^T = \sum_{j \in s(1,p(k))}
\frac{\partial R^0_{p(k)}}{\partial q_j} R_k R_k^T (R^0_{p(k)})^T
\dot{q}_j + \sum_{j \in s(k)} R^0_{p(k)} \frac{\partial R_k}{\partial q_j} R_k^T
(R^0_{p(k)})^T \dot{q}_j  \nonumber \\
& = & \sum_{j \in s(1,k)} (R^0_{p(l(j))} [\vc{u}_{l(j)j}] (R^0_{p(l(j))})^T) \dot{q}_j, \;\;\;\mathrm{where}\;\;
[\vc{u}_{l(j)j}] = \frac{\partial R_{l(j)}}{\partial q_j} R_{l(j)}^T
\end{eqnarray}
\ignorethis{
\begin{eqnarray}
[\bm{\omega}_k] & = & \dot{(R^0_{k-1}R_k)} (R^0_{k-1}R_k)^T = \sum_j
\frac{\partial R^0_{k-1}}{\partial q_j} R_k R_k^T (R^0_{k-1})^T
\dot{q}_j + \sum_j R^0_{k-1} \frac{\partial R_k}{\partial q_j} R_k^T
(R^0_{k-1})^T \dot{q}_j  \nonumber \\
& = & \sum_j ([\vc{s}_j] +R^0_{k-1} [\vc{t}_j] (R^0_{k-1})^T) \dot{q}_j, \;\;\;\mathrm{where}\;\;
\vc{s}_j = \frac{\partial R^0_{k-1}}{\partial q_j} (R^0_{k-1})^T, \;\;
\vc{t}_j = \frac{\partial R_k}{\partial q_j} R_k^T
\end{eqnarray}
}

Using the property of skew symmetric matrix, $[R \vc{u}] = R [\vc{u}]
R^T$, we can express the angular velocity in the vector form as
\begin{equation}
\label{eqn:angular_velocity}
\bm{\omega}_k = (\vc{u}_{11} \cdots R^0_{p(l(j))} \vc{u}_{l(j)j} \cdots \vc{0}) \dot{\vc{q}} = J_{\omega k} \dot{\vc{q}}
\end{equation}
where $j$ is in the set of $s(1,k)$, and $J_{\omega k}$ is a $3 \times
n$ matrix. Note that the zero columns in $J_{\omega k}$ correspond to
DOFs that are not in the chain of transformations from the root to the
link $k$. Let us look at a couple of examples using the articulated
rigid body system in Figure \ref{fig:example1}:
\begin{eqnarray}
\bm{\omega}_1 &=& (\vc{u}_{11} \;\; \vc{u}_{12} \;\; \vc{0}
\;\;\vc{0}\;\;\vc{0}\;\;\vc{0}\;\;\vc{0}) \dot{\vc{q}}  \nonumber \\
\bm{\omega}_4 &=& (\vc{u}_{11} \;\; \vc{u}_{12} \;\; R^0_1\vc{u}_{23} \;\;
R^0_1\vc{u}_{24} \;\;  R^0_1\vc{u}_{25} \;\; \vc{0} \;\;
R^0_2 \vc{u}_{47}) \dot{\vc{q}} \nonumber
\end{eqnarray}
where $\vc{u}$, $R\vc{u}$, and $\vc{0}$ are all $3\times 1$
vectors. Depending on the representation of the rotation matrix,
$\vc{u}$ can assume different values. For example, if the joint
between link $1$ and link $2$ in Figure \ref{fig:example1} is
represented as three Euler rotations, $R^{(x)}$, $R^{(y)}$, and
$R^{(z)}$, we have $\vc{u}_{23} = (1\;\; 0 \;\; 0)^T$, $\vc{u}_{24} =
R^{(x)} (0\;\;1\;\;0)^T$, and $\vc{u}_{25} = R^{(x)}R^{(y)}
(0\;\;0\;\;1)^T$. If the joint is represented as a quaternion or an
exponential map, $\vc{u}$ do not have a simple symbolic form.

\ignorethis{
\begin{equation}
\label{eqn:angular_velocity}
\bm{\omega}_k = (\vc{s}_1 \cdots \vc{s}_{np} \; R^0_{k-1} \vc{t}_1 \cdots
R^0_{k-1} \vc{t}_{nk}\; \vc{0} \cdots \vc{0}) \dot{\vc{q}} = J_{\omega k} \dot{\vc{q}}
\end{equation}
where $np$ is the number of DOFs in the parent chain and $nk$ is the
number of DOFs in the link $k$. 
}

Similarly, the linear velocity of the center of mass of the link $k$
can be expressed in terms of the generalized velocity: 
\begin{equation}
\vc{v}_k = J_{vk} \dot{\vc{q}}, \;\;\;\mathrm{where}\;\; J_{vk} = \frac{\partial T^0_k
  \vc{c}_k}{\partial \vc{q}}.
\end{equation}
where the chain of homogeneous transformations from the world frame to the local
frame of link $k$ is denoted as $T^0_k$. Note that $T^0_k$ is
different from $R^0_k$ in that $T^0_k$ includes the translational
transformations. $\vc{c}_k$ denotes the center of mass of link $k$ in
its local frame.

\sumit{Cut this part here and keep it for later. Instead, put $J_i$ for each link and go to next section.}

We can concatenate all $2m$  Jacobian matrices into a single Jacobian
that relates the generalized velocity to the Cartesian velocity of each
link:
\begin{equation}
\left[
\begin{array}{c}
\vc{v} \\
\bm{\omega} \\
\end{array}
\right] =
\left[
\begin{array}{c}
\vc{v}_1 \\
\vdots \\
\vc{v}_m \\
\bm{\omega}_1 \\
\vdots \\
\bm{\omega}_m
\end{array}
\right] = 
\left[
\begin{array}{c}
J_{v1} \\
\vdots \\
J_{vm} \\
J_{\omega 1} \\
\vdots \\
J_{\omega m}
\end{array}
\right] 
\left[
\begin{array}{c}
\dot{q}_1\\
\vdots \\
\dot{q}_n
\end{array}
\right]  = J \dot{\vc{q}}
\end{equation}

Typically, the Jacobian $J$ is full column rank because the
number of DOFs in the maximal representation is more than that in the
generalized representation, i.e $6m > n$. To compute $\dot{\vc{q}}$ from $(\vc{v}, \bm{\omega})$, we
will end up solving a over-constrained linear system. We can use
pseudo inverse of $J$ to compute $\dot{\vc{q}}$:
\begin{equation}
 \dot{\vc{q}} = (J^TJ)^{-1}J^T
\left[
\begin{array}{c}
\vc{v} \\
\bm{\omega}
\end{array}
\right]
 = J^+
\left[
\begin{array}{c}
\vc{v} \\
\bm{\omega}
\end{array}
\right]
\end{equation}

Alternatively, we can rewrite the equation using the relative angular
velocity between a child and a parent link expressed in the local
frame of the parent, instead of using angular velocity of each link
expressed in the world frame.
\begin{equation}
\hat{\bm{\omega}}_k = (R^0_{p(k)})^T(\bm{\omega}_k - \bm{\omega}_{p(k)}) = (\vc{0} \cdots \vc{0} \;\; \vc{u}_{l(j)j} \;\; \vc{0}
\cdots \vc{0}) \dot{\vc{q}} = \hat{J}_{\omega k} \dot{\vc{q}} 
\end{equation}
where $j$ is in the set of $s(k)$. Comparing the above equation with Equation \ref{eqn:angular_velocity},
the angular part of Jacobian, $\hat{J}_\omega$, is usually more sparse
that $J_\omega$.

\ignorethis{
\begin{equation}
\hat{\bm{\omega}}_k = (\vc{0} \cdots \vc{0} \;\vc{t}_1 \cdots \vc{t}_{nk}\;
\vc{0} \cdots \vc{0}) \dot{\vc{q}} = \hat{J}_{\omega k} \dot{\vc{q}} 
\end{equation}
}

\subsection{Equations of motion}
Describe the equations carrying over from rigid body section.

\section{Conversion between Cartesian and Generalized Coordinates}
In practice, we often want to use third-party rigid body simulators
rather than develop our own. There are a few widely used physics
engines that provide efficient, robust, and fairly accurate rigid body
simulation and collision handling. Open Dynamic Engine (ODE), PhysX, and
Bullet are perhaps the most popular free choices among game developers and
academic researchers. These commercial simulators use the maximal
representation rather than generalized coordinates
described above. That is, these simulators represent each link in the
articulated rigid body system as six DOFs,
leading to a redundant system with additional constraints between
links. A common practice is to develop control algorithms in
generalized coordinates and do forward simulation using a commercial
physics engine, such as ODE. This requires some conversion between
Cartesian and generalized coordinates.

\subsection{Definitions}
In the maximal coordinates, the state of an articulated rigid body
system can be expressed as $(\vc{x}_k, R_k, \vc{v}_k,
\boldsymbol{\bm{\omega}}_k)$, where $k = 1, \cdots, m$. Here $\vc{x}_k$ and
$R_k$ are the position and orientation of the rigid link $k$, and $(\vc{v}_k,
\boldsymbol{\bm{\omega}}_k)$ are the linear and angular velocity of the
rigid link $k$ viewed in the world frame. Similarly, we define the
Cartesian force and torque applied on rigid link $k$ as $(\vc{f}_k,
{\tau}_k)$, both of which are expressed in the world
frame.

The same articulated rigid body system can be represented in
generalized coordinates. We define the generalized state as $(q_j,
\dot{q}_j)$, where $j = 1, \cdots, n$. The corresponding generalized
forces are then defined as $(Q_1, \cdots, Q_n)$.

\subsection{Velocity conversion}
Let us first consider only one rigid body. From rigid body dynamics,
we can write down the relation between the orientation and the angular
velocity as $\dot{R} = [\bm{\omega}] R$, where $[\boldsymbol{\bm{\omega}}]$
denotes the skew symmetric matrix of ${\bm{\omega}}$. We can
then express the relation between the angular velocity and the
generalized velocity as
\begin{equation}
[\bm{\omega}] = \dot{R} R^{T} = \left(\sum_j \frac{\partial R}{\partial q_j}
\dot{q}_j \right) R^T = \sum_j\frac{\partial R}{\partial q_j} R^T
\dot{q}_j = \sum_j [\vc{j}_j] \dot{q}_j
\end{equation}
Here $[\vc{j}_j] = \frac{\partial R}{\partial q_j} R^T$ is a skew
symmetric matrix because $R \in SO(3)$. We can also express the
angular velocity as
\begin{equation}
\bm{\omega} = ( \vc{j}_1 \cdots \vc{j}_n) \dot{\vc{q}} = J_{\omega} \dot{\vc{q}}
\end{equation}
where $ J_{\omega} \in \vc{R}^{3 \times n}$ is the Jacobian matrix
that relates the generalized velocity to the angular velocity of the
rigid body.
 

\subsection{Force conversion}
The relation between the Cartesian force and the generalized force can
be found in Equation \ref{eq:virtual_work}:
\begin{equation}
\label{eqn:force_conversion}
\vc{Q} = \sum_i J_{vi}^T \vc{f}_i + \sum_k J_{\omega k}^T \tau_k = 
\left[
\begin{array}{cc}
J_{v}^T & J_\omega^T
\end{array}
\right]
\left[
\begin{array}{c}
\vc{f} \\
\bm{\tau}
\end{array}
\right] 
, \;\;\;\mathrm{where}\;\;
J_{vi} = \frac{\partial \vc{r}_i}{\partial \vc{q}}
\end{equation}
where $\vc{r}_i$ is the point of application of the Cartesian force
$\vc{f}_i$ expressed in the world frame. Body torque $\tau_k$ is the torque
applied on link $k$. 

Sometimes it is more convenient to express \emph{joint torques} in the
local frame of the parent link, rather than \emph{body torques} in the
world frame. For example, the joint torque between link $p(k)$ and
link $k$ can be computed as $\hat{\tau}_{p(k)} = (R^0_{p(k)})^T(\tau_{p(k)} -
\tau_k)$. Equation \ref{eqn:force_conversion} is then modified to:
\begin{equation}
\vc{Q} = \left[
\begin{array}{cc}
J_{v}^T & J_\omega^T
\end{array}
\right]
\left[
\begin{array}{c}
\vc{f} \\
\bm{\tau}
\end{array}
\right] 
 = \left[
\begin{array}{cc}
J_{v}^T & J_\omega^T
\end{array}
\right]
\left[
\begin{array}{c}
\vc{f} \\
D 
\left[
\begin{array}{c}
R^0_{p(1)} \hat{\tau}_1 \\
\vdots \\
R^0_{p(m)}) \hat{\tau}_m
\end{array}
\right]
\end{array}
\right] =
\left[
\begin{array}{cc}
J_{v}^T & \hat{J}_\omega^T
\end{array}
\right]
\left[
\begin{array}{c}
\vc{f} \\
\hat{\bm{\tau}}
\end{array}
\right]  
\end{equation}
where matrix $D$ encodes the relation between body torques and joint
torques. For example, matrix $D$ for the system in Figure \ref{fig:example1} looks
like:
\begin{equation}
D =
\left[
\begin{array}{cccc}
\vc{I}_{3\time 3}  & -\vc{I}_{3\time 3} & \vc{0} & \vc{0}\\
\vc{0} & \vc{I}_{3\time 3}  & -\vc{I}_{3\time 3} & -\vc{I}_{3\time 3}\\
\vc{0} & \vc{0} & \vc{I}_{3\time 3}  & \vc{0}\\
\vc{0} & \vc{0} & \vc{0} & \vc{I}_{3\time 3}\\
\end{array}
\right]  
\end{equation}


\section{Recursive Inverse and Forward Dynamics}