\section{Conversion between Cartesian and Generalized Coordinates}
In practice, we often want to use third-party rigid body simulators
rather than develop our own. There are a few widely used physics
engines that provide efficient, robust, and fairly accurate rigid body
simulation and collision handling. Open Dynamic Engine (ODE), PhysX, and
Bullet are perhaps the most popular free choices among game developers and
academic researchers. These commercial simulators use the maximal
representation rather than generalized coordinates
described above. That is, these simulators represent each link in the
articulated rigid body system as six DOFs,
leading to a redundant system with additional constraints between
links. A common practice is to develop control algorithms in
generalized coordinates and do forward simulation using a commercial
physics engine, such as ODE. This requires some conversion between
Cartesian and generalized coordinates.

\ignorethis{
\subsection{Definitions}
In the maximal coordinates, the state of an articulated rigid body
system can be expressed as $(\vc{x}_k, R_k, \vc{v}_k,
\boldsymbol{\bm{\omega}}_k)$, where $k = 1, \cdots, m$. Here $\vc{x}_k$ and
$R_k$ are the position and orientation of the rigid link $k$, and $(\vc{v}_k,
\boldsymbol{\bm{\omega}}_k)$ are the linear and angular velocity of the
rigid link $k$ viewed in the world frame. Similarly, we define the
Cartesian force and torque applied on rigid link $k$ as $(\vc{f}_k,
{\bm{\tau}}_k)$, both of which are expressed in the world
frame.
The same articulated rigid body system can be represented in
generalized coordinates. We define the generalized state as $(q_j,
\dot{q}_j)$, where $j = 1, \cdots, n$. The corresponding generalized
forces are then defined as $(Q_1, \cdots, Q_n)$.
}

\subsection{Velocity conversion}

We can concatenate all $2m$ Jacobian matrices corresponding to each link into a single Jacobian
that relates the generalized velocity to the Cartesian velocity of each
link:
\begin{equation}
\vc{V} \equiv 
\left(
\begin{array}{c}
\vc{v}_1 \\
\vdots \\
\vc{v}_m \\
\bm{\omega}_1 \\
\vdots \\
\bm{\omega}_m
\end{array}
\right) = 
\left (
\begin{array}{c}
J_{v1} \\
\vdots \\
J_{vm} \\
J_{\omega 1} \\
\vdots \\
J_{\omega m}
\end{array}
\right) 
\left(
\begin{array}{c}
\dot{\vc{q}}_1\\
\vdots \\
\dot{\vc{q}}_m
\end{array}
\right)  \equiv \left(
\begin{array}{c}
J_v\\
J_{\omega}
\end{array}
\right)\dot{\vc{q}} \equiv J \dot{\vc{q}}
\end{equation}

Typically, the Jacobian $J$ is full column rank because the
number of DOFs in the maximal representation is more than that in the
generalized representation, i.e $6m > n$. To compute $\dot{\vc{q}}$ from $\vc{V}$, we
will end up solving an over-constrained linear system. We can use the
pseudo inverse of $J$ to compute $\dot{\vc{q}}$:
\begin{equation}
 \dot{\vc{q}} =  J^+\vc{V}
 \end{equation}
where the pseudo-inverse notation $J^+ = (J^TJ)^{-1}J^T$. If this
<<<<<<< HEAD
least-squared solution does not exactly solve the linear
=======
least-squares solution does not exactly solve the linear
>>>>>>> karen
system (i.e. $J \dot{\vc{q}} = \vc{V}$), it indicates that $\vc{V}$ cannot be achieved in the
generalized coordinates without violating constraints of the system
(e.g. constraints that keep links connected).

Computing $J^+$ may be expensive for a system with many rigid links. 
Alternatively, we can rewrite the equation using the relative velocity between a child and a parent link expressed in the local
frame of the parent, instead of using velocities of each link
expressed in the world frame. As an example, we write the simplified expression for the angular velocity of link $k$ using \eqnref{angvelk_iterative} as: 
\begin{eqnarray}
\nonumber
\bm{\omega}_k - \bm{\omega}_{p(k)} & = & R^0_{p(k)}\hat{\bm{\omega}}_k = R^0_{p(k)}\hat{J}_{\omega k} \dot{\vc{q}}_k \\
\Rightarrow \left ( -\vc{I}_3\;\; \vc{I}_3 \right ) 
\left ( 
\begin{array}{c}
\bm{\omega}_{p(k)}\\
\bm{\omega}_k
\end{array}
\right ) & = & R^0_{p(k)}\hat{J}_{\omega k} \dot{\vc{q}}_k
\end{eqnarray}

%\begin{pmatrix}
%\vc{0}  &                    &  &\\
%        & \ddots             &  & \\
%        &                    & R^0_{p(k)}\hat{J}_{\omega k} & \\
%        &                    &  & \ddots & \\
%        &                    &   &     & \vc{0}
%\end{pmatrix} 

Combining these equations for all the links, we get:
\begin{eqnarray}
\label{eq:jacsplit}
\nonumber
D \bm{\omega} = D J_{\omega} \dot{\vc{q}} & = & \mbox{blockdiag}(\hat{J}_{\omega 1},\hdots,R^0_{p(m)}\hat{J}_{\omega m})\dot{\vc{q}}\\
\nonumber
& = & \mbox{blockdiag}(\vc{I}_3,\hdots,R^0_{p(m)})\mbox{blockdiag}(\hat{J}_{\omega 1},\hdots,\hat{J}_{\omega m})\dot{\vc{q}}\\
& \equiv & R \hat{J}_{\omega}\dot{\vc{q}}
\end{eqnarray}
where $D$ is a constant matrix that encodes the connectivity between links. For example, matrix $D$ for the system in Figure \ref{fig:example1} looks
like:
\begin{equation}
D =
\left (
\begin{array}{cccc}
\vc{I}_{3}  & \vc{0} & \vc{0} & \vc{0}\\
-\vc{I}_{3} & \vc{I}_{3}  & \vc{0} & \vc{0}\\
\vc{0} & -\vc{I}_{3} & \vc{I}_{3}  & \vc{0}\\
\vc{0} & -\vc{I}_{3} & \vc{0} & \vc{I}_{3}\\
\end{array}
\right )  
\end{equation}
The relations between $\hat{\bm{\omega}}$ and $\bm{\omega}$, and $\hat{J}_{\omega}$ and $J_{\omega}$ follow from \eqnref{jacsplit}:
\begin{eqnarray}
\label{eq:jacbodyhat}
\nonumber
\hat{\bm{\omega}} & = &R^T D \bm{\omega}\\
\mbox{and } \hat{J}_{\omega} & = & R^T D J_{\omega}
\end{eqnarray}
The matrix $\hat{J}_{\omega}$ being block diagonal is much sparser as compared to ${J}_{\omega}$. 

\ignorethis{
If $\vc{q}$ satisfies the over-constrained system of equations $\vc{V} = J\dot{\vc{q}}$, we need only $n$ constraints out of $6m$ to uniquely determine $\dot{\vc{q}}$ from the Cartesian velocities $\vc{V}$. Equivalently, we can collect $k$ number of rows from $J$ in $J'$ such that the rank of $J'$ is $n$, and compute $\dot{\vc{q}} = J'^+ \vc{V}'$, where $\vc{V}'$ are the velocity components corresponding to the rows in $J'$. This computed $\dot{\vc{q}}$ still satisfies $\vc{V} = J\dot{\vc{q}}$. 
%Therefore, $\dot{\vc{q}}$ computed in \eqnref{angvel_cart2gen} also satisfies the linear velocity relation $\vc{v} = J_v \dot{\vc{q}}$.
}

If $\dot{\vc{q}}$ satisfies the over-constrained system of equations $\vc{V}
= J\dot{\vc{q}}$, using any $n$ independent constraints out of $6m$ to
solve this linear system will result in the same $\dot{\vc{q}}$. This
can be explained by the problem of fitting an unknown plane to $6m$ 3D
points as $A\vc{x} = \vc{b}$, where $A \in \Re^{6m \times 3}$. If all
$6m$ points happen to lie on a plane, i.e. there exists an $\vc{x}$
that exactly satisfies the over-constrained system, any three
distinctive points we pick as the constraints will result in the same
plane. Therefore, if we know $\vc{V}$ can be achieved in the
generalized coordinates, we can pick a subset of rows from $J$ to form
a $J'$ such that the rank of $J'$ is $n$, and compute $\dot{\vc{q}} =
J'^+ \vc{V}'$, where $\vc{V}'$ are the velocity components
corresponding to the rows in $J'$. The solution $\dot{\vc{q}}$ to this
system will be the same for any $J'$.


For a system with only rotational DOFs, it is sufficient
to invert only $J_{\omega}$ which is also a full column rank matrix
($J_{\omega} \in \Re^{3m \times n}$ and $n\leq 3m$). This is because
each rotational joint can have at most three independent DOFs.  We
then can compute the velocities of the rotational DOFs $\dot{\vc{q}}$
as:
\begin{eqnarray}
\label{eq:angvel_cart2gen}
\nonumber
 \dot{\vc{q}} & = & J_{\omega}^+ \bm{\omega}\\
 \nonumber
 & = &  \hat{J}_{\omega}^+ R^T D\bm{\omega} = \hat{J}_{\omega}^+ \hat{\bm{\omega}} \\
% & = & \mbox{blockdiag}\left(\hat{J}_{\omega 1}^+,\hdots,\hat{J}_{\omega m}^+\right ) \mbox{blockdiag}\left(\vc{I}_3,\hdots,{R^0_{p(m)}}^T\right ) D\bm{\omega}
\nonumber
& = & \mbox{blockdiag}\left(\hat{J}_{\omega 1}^+,\hdots,\hat{J}_{\omega m}^+\right ) \hat{\bm{\omega}}\\
\mbox{or\ \ } \dot{\vc{q}}_k & = & \hat{J}_{\omega k}^+ \hat{\bm{\omega}}_k \mbox{\ \ , } k \in 1\hdots m
\end{eqnarray}
From this formulation, we see that the problem of computing the
pseudo-inverse of a matrix $J_{\omega}$ is reduced to computing $m$
pseudo-inverses of much smaller constant-sized matrices
$\hat{J}_{\omega k}$. Note that if $\dot{\vc{q}}$ computed in
\eqnref{angvel_cart2gen} exactly satisfies the linear system
$\bm{\omega} = J_{\omega} \dot{\vc{q}}$, it also satisfies the linear
velocity relation $\vc{v} = J_v \dot{\vc{q}}$.

\ignorethis{
Note that if $\vc{V}$ can be achieved in the generalized coordinates,
there exists a unique $\dot{\vc{q}}$ satisfying $\vc{V}' =
J'\dot{\vc{q}}$, where $J'$ is formed by arbitrarily choosing $n$
independent rows from $J$ and $\vc{V}'$ comprises the corresponding
elements in $\vc{V}$. Therefore, if $\vc{V}$ is achievable without
violating the system constraints, $\dot{\vc{q}}$ computed in
\eqnref{angvel_cart2gen} will also satisfy the linear velocity:
$\vc{v} = J_v \dot{\vc{q}}$.}


For systems that include translational DOFs as well, we can separately solve for the rotational DOFs as in \eqnref{angvel_cart2gen} and solve for the translational DOFs for any link $k$ as $\dot{\vc{q}}_k = J_{vk}^+\vc{v}_k$. In most of the cases, only the root joint has translational DOFs making the computation of generalized translational velocities extremely simple as $J_{v1}$ becomes an identity matrix.


\subsection{Force conversion}
The relation between the Cartesian force and the generalized force can
be found in \eqnref{virtual_work}:
\begin{equation}
\label{eq:force_conversion}
\vc{Q} = \sum_k {J^{'}_{vk}}^T \vc{f}_k + J_{\omega k}^T \bm{\tau}^{'}_k = 
\left (
\begin{array}{cc}
{J^{'}_{v}}^T & J_\omega^T
\end{array}
\right)
\left(
\begin{array}{c}
\vc{f} \\
\bm{\tau}^{'}
\end{array}
\right) 
, \;\;\;\mathrm{where}\;\;
J^{'}_{vk} = \frac{\partial \vc{r}_k}{\partial \vc{q}}
\end{equation}
where $\vc{r}_k$ is the point of application of the Cartesian force
$\vc{f}_k$ and $\bm{\tau}^{'}_k$ is the \emph{body torque} applied to
link $k$ expressed in the world frame.

\paragraph{Note.} Body torque $\bm{\tau}^{'}_k$ is different from body
torque $\bm{\tau}_k$ in \eqnref{summary_dynamics}:
\begin{equation}
\vc{Q} =  J_v^T \vc{f} + J_\omega^T \bm{\tau} \nonumber
\end{equation}
Here, $\bm{\tau}^{'}_k$ is the torque applied on link $k$ in the world
frame and does \emph{not} include the torque induced by the linear
forces $\vc{f}_k$.  However, $\bm{\tau}_k$ in
\eqnref{summary_dynamics} \emph{includes} the torque
$[\vc{r}_k-\vc{x}_k] \vc{f}_k$ due to each force $\vc{f}_k$
($\vc{x}_k$ is the COM of the link $k$). As a result, the linear
Jacobian $J_{v}$ in \eqnref{summary_dynamics} is computed at the COM
of the respective rigid link and $J^{'}_{v}$ in
\eqnref{force_conversion} is defined for the point of application of
the force. It is easy to verify that ${J^{'}_{vk}}^T\vc{f}_k =
J_{vk}^T\vc{f}_k + J_{\omega k}^T[\vc{r}_k-\vc{x}_k] \vc{f}_k$. \ie
$\bm{\tau}_k = \bm{\tau}^{'}_k + [\vc{r}_k-\vc{x}_k] \vc{f}_k$.
%However, for the sake of clarity, we use the new definition of the Jacobian in \eqnref{force_conversion} and abuse the notation by denoting it by $J_v$.
\ignorethis{
\paragraph{Note.} Body torque $\bm{\tau}^{'}_k$ is the torque applied
on link $k$ in the world frame and does \emph{not} include the torque
induced by the linear forces $\vc{f}_k$.  However, the definition for
torque in \eqnref{summary_dynamics} \emph{includes} the torque
$[\vc{r}_k-\vc{x}_k] \vc{f}_k$ due to each force $\vc{f}_k$
($\vc{x}_k$ is the COM of the link $k$). As a result, the linear
Jacobian $J_{v}$ in \eqnref{summary_dynamics} is defined for the COM
of the respective rigid link and $J^{'}_{v}$ in
\eqnref{force_conversion} is defined for the point of application of
the force. It is easy to verify that ${J^{'}_{vk}}^T\vc{f}_k =
J_{vk}^T\vc{f}_k + J_{\omega k}^T[\vc{r}_k-\vc{x}_k] \vc{f}_k$. \ie
$\bm{\tau}_k = \bm{\tau}^{'}_k + [\vc{r}_k-\vc{x}_k] \vc{f}_k$.
%However, for the sake of clarity, we use the new definition of the Jacobian in \eqnref{force_conversion} and abuse the notation by denoting it by $J_v$.
}

Often many controllers (such as a tracking controller) find it convenient to compute the Cartesian-space \emph{joint torques} in the local frame of the parent link rather than body torques in the world frame. Joint torque $\hat{\bm{\tau}}_k$ in the frame of a parent link $p(k)$ is defined such that positive torque in the world frame $R^0_{p(k)}\hat{\bm{\tau}}_k$ is applied to the link $k$ and negative torque $-R^0_{p(k)}\hat{\bm{\tau}}_k$ is applied to the parent link $p(k)$. Therefore, the body torque $\bm{\tau}^{'}_k$ applied to the link $k$ can be written in terms of the joint torques as $\bm{\tau}^{'}_k = R^0_{p(k)}\hat{\bm{\tau}}_k - \sum_l R^0_{k} \hat{\bm{\tau}}_l$, $\forall l:k=p(l)$. Collecting the body torques for all the rigid links in the vector $\bm{\tau}$, the relation between the body torques and the joint torques can be defined as:
\begin{eqnarray}
\label{eq:torquesbodyhat}
\bm{\tau}^{'} & = & D^T R \hat{\bm{\tau}} = (R^T D)^T \hat{\bm{\tau}}
\end{eqnarray}
where $R, D$ are defined in \eqnref{jacbodyhat}. We now substitute \eqnref{torquesbodyhat} in \eqnref{force_conversion} and get:
\begin{eqnarray}
\label{eq:torques_cart2gen}
\nonumber
\vc{Q} & = & 
\left (
\begin{array}{cc}
{J^{'}_{v}}^T & J_\omega^T
\end{array}
\right )
\begin{pmatrix}
\vc{f} \\
(R^T D)^T \hat{\bm{\tau}}
\end{pmatrix}
 \\
\nonumber
& = & 
\left (
\begin{array}{cc}
{J^{'}_{v}}^T & (R^T D J_\omega)^T
\end{array}
\right )
\left (
\begin{array}{c}
\vc{f} \\
\hat{\bm{\tau}}
\end{array}
\right )
\\
& = & 
\left (
\begin{array}{cc}
{J^{'}_{v}}^T & \hat{J}_\omega^T
\end{array}
\right )
\left (
\begin{array}{c}
\vc{f} \\
\hat{\bm{\tau}}
\end{array}
\right )  \mbox{\ \ (Using \eqnref{jacbodyhat})}
\end{eqnarray}

\eqnref{torques_cart2gen} gives the relation to convert the given cartesian forces \vc{f} and joint torques $\hat{\bm{\tau}}$ to the generalized forces $\vc{Q}$. 

We now describe the process to convert the given generalized forces $\vc{Q}$ to cartesian forces and torques. In general, the transposed Jacobian in \eqnref{force_conversion} can be inverted using a pseudo-inverse to get the Cartesian forces and torques. Note that the relation represents an under-constrained system when solving for $\vc{f}$ and $\bm{\tau}^{'}$. This is because the size of the unknowns is $6m$ and the number of constraints are $n$ with $n\le 6m$. Therefore, we get particular solutions for the Cartesian forces and torques out of many possible solutions.

Based on the information about the form of $\vc{Q}$, we can solve for the Cartesian forces and torques in different ways. We describe the solutions to the following cases:
\begin{enumerate}
<<<<<<< HEAD
\item \textbf{General case. } In the most general case, the points of application of the Cartesian forces are not known. Therefore, we cannot use the Jacobian $J_{v}^{'}$ in \eqnref{force_conversion}. This forces us to assume the points of application to be the COM of each link and compute the torques $\bm{\tau}$ instead of body torques $\bm{\tau}^{'}$. \ie, we can invert the transposed Jacobian by computing its pseudo-inverse that results in a particular least-squared solution for $\vc{f}$ and $\bm{\tau}$ as:
=======
\item \textbf{General case. } In the most general case, the points of application of the Cartesian forces are not known. Therefore, we cannot use the Jacobian $J_{v}^{'}$ in \eqnref{force_conversion}. This forces us to assume the points of application to be the COM of each link and compute the torques $\bm{\tau}$ instead of body torques $\bm{\tau}^{'}$. \ie, we can invert the transposed Jacobian by computing its pseudo-inverse that results in a particular least-squares solution for $\vc{f}$ and $\bm{\tau}$ as:
>>>>>>> karen
\begin{equation}
\left (
\begin{array}{c}
\vc{f} \\
\bm{\tau}
\end{array}
\right ) = \left (
\begin{array}{cc}
{J_{v}}^T & {J}_\omega^T
\end{array}
\right )^+ \vc{Q}
\end{equation}
If the points of the force application are known, the Jacobian in \eqnref{torques_cart2gen} can be inverted to obtain the forces $\vc{f}$ and the joint torques $\hat{\bm{\tau}}$.

\item \textbf{No linear forces. } The more common case for many controllers involves the conversion of only the joint torques from generalized to the Cartesian coordinates. Therefore, the linear forces \vc{f} are zero and \eqnref{torques_cart2gen} can be simplified further to result in the following conversion relation:
\begin{eqnarray}
\nonumber
\hat{\bm{\tau}}  & = & (\hat{J}_{\omega}^T)^+ \vc{Q}\\
\mbox{or } \hat{\bm{\tau}}_k  & = & (\hat{J}_{\omega k}^T)^+ \vc{Q}_k \;\; \forall k \in 1\hdots m
\end{eqnarray}
<<<<<<< HEAD
where $\vc{Q}_k$ denotes the components of the generalized forces corresponding to the rotational DOFs $\vc{q}_k$. Note that the size of the matrix $\hat{J}_{\omega k}^T$ is $n(k)\times 3$ and $n(k)\leq 3$. This implies that we get a particular least-squared solution for each $\hat{\bm{\tau}}_k$ out of possibly many solutions that would give rise to the same $\vc{Q}_k$ using the relation $\vc{Q}_k = \hat{J}_{\omega k}^T \hat{\bm{\tau}}_k$.
=======
where $\vc{Q}_k$ denotes the components of the generalized forces corresponding to the rotational DOFs $\vc{q}_k$. Note that the size of the matrix $\hat{J}_{\omega k}^T$ is $n(k)\times 3$ and $n(k)\leq 3$. This implies that we get a particular least-squares solution for each $\hat{\bm{\tau}}_k$ out of possibly many solutions that would give rise to the same $\vc{Q}_k$ using the relation $\vc{Q}_k = \hat{J}_{\omega k}^T \hat{\bm{\tau}}_k$.
>>>>>>> karen
%\item \textbf{Known points of applied forces. } When the points of application of forces are known, \eqnref{torques_cart2gen} can be used, instead of inverting the Jacobian.

\end{enumerate}

%\section{Recursive Inverse and Forward Dynamics}
