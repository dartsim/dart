# Collision Detector Task - Progress

## Status

- Phase 2 (core implementation) is in progress.
- Phase 2.5 (default switch + deprecation) complete: built-in detector is the
  default, backend-selection APIs are deprecated, and examples/docs are
  migrated.
- Latest local runs: `pixi run build-tests` and `pixi run ctest --test-dir build/default/cpp/Release --output-on-failure -R UNIT_collision_DartRaycast` pass.
- Captured raycast benchmark baseline via `pixi run bm bm_raycast_dart -- --benchmark_filter=BM_RaycastDart` (CPU scaling enabled; results may be noisy).
- Raycast baseline (Release): Closest 32=1.90us, 128=7.54us, 512=32.0us; AllHits 32=2.18us, 128=8.59us, 512=38.0us.
- Core data and broadphase scaffolding are in place, with AABB caching.
- Narrowphase supports sphere, box, cylinder, and plane primitives.
- Raycast is available for the supported primitives with AABB pruning.
- Distance query MVP is implemented for supported primitives with sweep and AABB pruning.
- Raycast tests now cover box, cylinder, and plane hits.
- Core/adapter boundary decisions are captured in the architecture proposal.
- Distance tests now cover sphere-plane, sphere-box, sphere-cylinder, and box-cylinder nearest points.
- Raycast tests now include inside-hit cases for sphere, box, and cylinder.
- Raycast tests now include surface-start hits for sphere, box, cylinder, and plane.
- Raycast tests now include parallel plane surface-start misses.
- Distance tests include rotated box coverage, and raycast tests include a rotated plane hit.
- Raycast tests include tangent sphere hits and parallel plane misses.
- Distance tests now check cylinder-cylinder nearest points; raycast tests include tangent cylinder hits.
- Raycast tests include cylinder cap rim hits.
- Raycast tests include cylinder parallel misses.
- Raycast tests include tangent box hits.
- Raycast tests include box parallel misses.
- Raycast tests include rotated box parallel misses.
- Distance tests include a rotated plane case for sphere-plane queries.
- Raycast tests include rotated plane offset hits.
- Raycast tests include rotated plane parallel misses.
- Raycast tests include rotated plane parallel surface-start misses.
- Raycast tests include rotated plane offset surface-start hits.
- Raycast tests include rotated plane offset parallel misses.
- Raycast tests include rotated plane offset parallel surface-start misses.
- Distance tests include rotated box/cylinder plane cases, and raycast tests include rotated box hits.
- Raycast tests include rotated cylinder hits.
- Raycast tests include rotated cylinder inside hits.
- Raycast tests include rotated cylinder parallel misses.
- Distance tests include box-plane offset coverage.
- Distance tests include a group-group distance case to validate pair selection.
- Distance tests include diagonal box-box coverage for oblique nearest points.
- Distance tests include group-group filter coverage for distance queries.
- Distance tests include overlapping sphere coverage for negative distances.
- Distance tests include overlapping box coverage for negative distances.
- Distance tests include overlapping cylinder-plane coverage for negative distances.
- Distance tests include single-group filter coverage for distance queries.
- Distance tests include group-group shared-object skip coverage.
- Distance tests include diagonal cylinder-cylinder coverage for oblique separation.
- Distance tests include perpendicular cylinder-cylinder coverage for non-parallel axes.
- Distance tests include rotated box-box coverage for aligned separation.
- Distance tests include skewed box-box coverage for mixed rotations.
- Distance tests include skewed box-cylinder coverage for non-parallel axes.
- Distance tests include coverage for filters rejecting all pairs.
- Distance tests include rotated box-cylinder coverage for axial separation.
- Distance tests include diagonal box-cylinder coverage for oblique separation with axial offsets.
- Distance tests include ellipsoid-as-sphere coverage.
- Raycast tests include ellipsoid-as-sphere coverage.
- Collision tests include ellipsoid-as-sphere coverage.
- Distance tests include empty-group coverage for single and group-group queries.
- Distance pruning skips separated pairs once a negative minimum distance is found.
- Distance tests include diagonal sphere-cylinder coverage for oblique separation with axial offsets.
- Distance tests include overlapping sphere-plane coverage for negative distances.
- Distance tests include overlapping box-plane coverage for negative distances.
- Distance tests include plane offset coverage for sphere queries; raycast tests include plane offset hits.
- Distance tests include rotated plane offset coverage for sphere-plane distances.
- Distance tests include plane offset coverage for cylinder-plane distances.
- Distance tests include plane offset coverage for box-plane distances.
- Distance tests include rotated cylinder-plane offset coverage.
- Distance tests include rotated cylinder-plane offset overlap coverage.
- Distance tests include a tilted cylinder-plane case for oblique extent coverage.
- Distance tests include tilted plane overlap coverage for cylinder-plane distances.
- Distance tests include tilted plane offset overlap coverage for cylinder-plane distances.
- Distance tests include tilted plane nearest-point coverage for sphere-plane and cylinder-plane distances.
- Distance tests include tilted plane offset coverage for cylinder-plane nearest points.
- Distance tests include tilted plane offset coverage for sphere-plane nearest points.
- Distance tests include tilted plane offset overlap coverage for sphere-plane distances.
- Distance tests include tilted plane overlap coverage for sphere-plane distances.
- Distance tests include tilted plane offset coverage for box-plane nearest points.
- Distance tests include tilted plane offset overlap coverage for box-plane distances.
- Distance tests include tilted plane overlap coverage for box-plane distances.
- Distance tests include DistanceResult clamping status coverage.
- Raycast tests include zero-length ray coverage.
- Distance tests include coverage for DistanceOption without nearest points.
- Raycast tests include empty-group coverage.
- Collision tests include empty-group coverage.
- Distance tests include missing-shape coverage.
- Raycast tests include missing-shape coverage.
- Collision tests include missing-shape coverage.
- Raycast now runs in DartCollisionEngine with detector forwarding.
- Raycast now reserves hits for all-hit queries and exits early on zero-fraction hits.
- Added a DART raycast benchmark covering closest-hit and all-hit queries.
- Moved core engine implementation files into `dart/collision/dart/engine` and updated includes to use the engine path.
- Renamed adapter file names to `DartCollision*` and updated includes to match the new paths.
- Gated DART raycast behind `DARTCollisionDetector::setRaycastEnabled` and updated DART raycast tests and benchmarks to enable it explicitly.
- Verified `pixi run -e gazebo test-gz` passes after the layout and raycast gating changes.
- Fixed CI build issues by adding an out-of-line `DARTCollisionDetector` destructor, updating distance filter tests to use shared_ptrs, and formatting the engine file.
- Fixed plane AABB handling to avoid NaNs and restored single-group distance result ordering to match group insertion order.
- Added axis-aligned distance paths for box-box, cylinder-box, and parallel cylinder-cylinder cases, plus plane-aligned nearest point selection for box-plane, sphere-plane, and cylinder-plane.
- Updated ellipsoid-as-sphere core radius to use diameters.
- Fixed box inside-hit raycast normal/fraction selection.
- Switched the default collision detector to the built-in detector in world and
  constraint solver construction.
- Deprecated backend-selection APIs and added deprecation notes to legacy
  detector classes.
- Updated `.skel` parsing to ignore collision detector selection with a
  deprecation warning.
- Migrated examples/tutorials away from backend-selection APIs and added
  deprecation suppressions in tests/benchmarks.
- Updated docs to describe legacy collision backends as deprecated.

## Completed Checkpoints

- Core engine path wired into the DART detector with AABB prechecks.
- Sweep-based broadphase candidate generation for single and group queries.
- Primitive narrowphase coverage for sphere, box, cylinder, and plane pairs.
- Added box-cylinder and cylinder-cylinder narrowphase support with DART-only unit tests.
- Added a DART-focused distance unit test suite for primitives.
- Added a DART distance benchmark and expanded distance edge-case tests.
- Raycast support for primitives plus DART-only unit coverage.
- Added a DART collision benchmark variant for baseline tracking.
- Added sweep-based pruning for distance queries with AABB lower bounds.
- Documented the core/adapter boundary and raycast placement in the architecture proposal.
- Expanded distance tests for sphere-plane, sphere-box, sphere-cylinder, and box-cylinder.
- Added inside-hit raycast coverage for sphere, box, and cylinder.
- Added surface-start raycast coverage for sphere, box, cylinder, and plane.
- Added parallel plane surface-start raycast miss coverage.
- Added rotated box distance coverage and a rotated plane raycast check.
- Added tangent sphere and parallel plane raycast coverage.
- Added cylinder-cylinder nearest-point checks and tangent cylinder raycast coverage.
- Added cylinder cap rim raycast coverage.
- Added cylinder parallel raycast miss coverage.
- Added tangent box raycast coverage.
- Added box parallel raycast miss coverage.
- Added rotated box parallel raycast miss coverage.
- Added rotated plane distance coverage for sphere-plane.
- Added rotated plane offset raycast coverage.
- Added rotated plane parallel raycast miss coverage.
- Added rotated plane parallel surface-start raycast miss coverage.
- Added rotated plane offset surface-start raycast coverage.
- Added rotated plane offset parallel raycast miss coverage.
- Added rotated plane offset parallel surface-start raycast miss coverage.
- Added rotated box raycast coverage and rotated box/cylinder plane distance checks.
- Added rotated cylinder raycast coverage.
- Added rotated cylinder inside-hit raycast coverage.
- Added rotated cylinder parallel raycast miss coverage.
- Added box-plane offset distance coverage.
- Added group-group distance coverage to validate pair selection and nearest points.
- Added diagonal box-box distance coverage to validate oblique nearest points.
- Added group-group distance filter coverage to validate filter application.
- Added overlapping sphere distance coverage for negative distance semantics.
- Added overlapping box distance coverage for negative distance semantics.
- Added overlapping cylinder-plane distance coverage for negative distance semantics.
- Added single-group distance filter coverage.
- Added group-group distance coverage for shared-object skipping.
- Added diagonal cylinder-cylinder distance coverage for oblique separation.
- Added perpendicular cylinder-cylinder distance coverage for non-parallel axes.
- Added rotated box-box distance coverage for aligned separation.
- Added skewed box-box distance coverage for mixed rotations.
- Added skewed box-cylinder distance coverage for non-parallel axes.
- Added distance coverage for filters rejecting all pairs.
- Added rotated box-cylinder distance coverage for axial separation.
- Added diagonal box-cylinder distance coverage for oblique separation with axial offsets.
- Added ellipsoid-as-sphere distance coverage.
- Added ellipsoid-as-sphere raycast coverage.
- Added ellipsoid-as-sphere collision coverage.
- Added empty-group distance coverage for single and group-group queries.
- Tightened distance AABB pruning once a penetrating pair is found.
- Added diagonal sphere-cylinder distance coverage for oblique separation with axial offsets.
- Added overlapping sphere-plane distance coverage for negative distance semantics.
- Added overlapping box-plane distance coverage for negative distance semantics.
- Added plane offset coverage for sphere distance and raycast queries.
- Added rotated plane offset coverage for sphere-plane distances.
- Added plane offset coverage for cylinder-plane distances.
- Added plane offset coverage for box-plane distances.
- Added rotated cylinder-plane offset distance coverage.
- Added rotated cylinder-plane offset overlap distance coverage.
- Added tilted cylinder-plane distance coverage for oblique extent checks.
- Added tilted cylinder-plane overlap distance coverage.
- Added tilted plane offset overlap coverage for cylinder-plane distances.
- Added tilted plane nearest-point coverage for sphere-plane and cylinder-plane distances.
- Added tilted plane offset coverage for cylinder-plane nearest points.
- Added tilted plane offset coverage for sphere-plane nearest points.
- Added tilted plane offset overlap coverage for sphere-plane distances.
- Added tilted plane overlap coverage for sphere-plane distances.
- Added tilted plane offset coverage for box-plane nearest points.
- Added tilted plane offset overlap coverage for box-plane distances.
- Added tilted plane overlap coverage for box-plane distances.
- Added DistanceResult clamping status coverage.
- Added zero-length raycast coverage.
- Added coverage for DistanceOption without nearest points.
- Added empty-group raycast coverage.
- Added empty-group collision coverage.
- Added missing-shape distance coverage.
- Added missing-shape raycast coverage.
- Added missing-shape collision coverage.
- Moved raycast implementation into DartCollisionEngine.
- Added minor raycast early-exit and hit reservation optimizations.
- Added a DART raycast benchmark for closest-hit and all-hit cases.
- Moved core engine implementation files into `dart/collision/dart/engine` and updated includes to use the engine path.
- Renamed adapter file names to `DartCollision*` and updated includes to match the new paths.
- Gated DART raycast behind `DARTCollisionDetector::setRaycastEnabled` and updated DART raycast tests and benchmarks to enable it explicitly.
- Fixed box inside-hit raycast normal/fraction selection.
- Captured raycast benchmark baseline via `pixi run bm bm_raycast_dart -- --benchmark_filter=BM_RaycastDart`.

## Next Steps

- Expand distance coverage for additional rotated or oblique configurations and refine nearest-point accuracy.
- Validate build and install paths after the engine layout change.
- Continue parity/performance tracking to justify future legacy backend removal.
