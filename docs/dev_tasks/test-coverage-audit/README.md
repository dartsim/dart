# Test Coverage Audit — Dev Task

## Current Status

- [x] Phase 0: Initial assessment and branch setup
- [x] Phase 1: Enable valid disabled tests (3 of 4 enabled)
- [x] Phase 2: Fix coverage infrastructure (lcov filters, codecov.yml)
- [x] Phase 3: Identify and prioritize coverage gaps (see `02-coverage-gaps.md`)
- [ ] Phase 4: Implement high-value tests (in progress - NameManager done)
- [ ] Phase 5: Establish ongoing coverage standards

## Goal

Improve DART's test coverage from ~67% to 80%+ with meaningful, maintainable tests that validate behavior and contracts—not just line counts.

## Current Coverage Analysis

| Scope              | Line Coverage | Notes                         |
| ------------------ | ------------- | ----------------------------- |
| All DART (`dart/`) | ~62.8%        | Includes GUI, experimental    |
| Core DART          | ~69.4%        | Excludes GUI, experimental    |
| Codecov reported   | ~67%          | May include third-party noise |
| Target             | 85%           | Per codecov.yml               |

### Coverage Infrastructure Issues (CRITICAL)

**Problem**: The `coverage.info` file generated by `pixi run coverage-report` includes third-party headers from `.pixi/envs/default/include/` (Eigen, assimp, OpenThreads, etc.) because the lcov `--remove` filter doesn't exclude them.

**Impact**: Coverage metrics are polluted with code we don't control, making the reported percentage meaningless.

**Fix Required**: Update `pixi.toml` coverage-report task to filter `.pixi/*` paths.

## Key Findings

### 1. Test Suite Structure (Good)

| Directory            | Files   | Purpose                    |
| -------------------- | ------- | -------------------------- |
| `tests/unit/`        | 119     | Isolated component testing |
| `tests/integration/` | 68      | Cross-module testing       |
| `tests/benchmark/`   | 19      | Performance measurement    |
| `tests/helpers/`     | 3       | Shared test utilities      |
| `tests/common/`      | 3       | LCP test fixtures          |
| **Total**            | **206** |                            |

Existing helpers are well-designed:

- `GTestUtils.hpp` - Eigen comparison macros, custom assertions
- `dynamics_helpers.hpp` - Skeleton/joint creation helpers
- `common_helpers.hpp` - General utilities
- `LcpTestFixtures.hpp` - LCP solver test infrastructure

### 2. Module Coverage Distribution (Estimated)

| Module             | Files | Test Coverage | Priority |
| ------------------ | ----- | ------------- | -------- |
| `dart/dynamics/`   | 179   | Medium        | High     |
| `dart/common/`     | 105   | Low-Medium    | Medium   |
| `dart/collision/`  | 92    | Medium        | High     |
| `dart/math/`       | 86    | High          | Low      |
| `dart/gui/`        | 77    | Excluded      | N/A      |
| `dart/simulation/` | 72    | Medium        | High     |
| `dart/constraint/` | 44    | Medium        | High     |
| `dart/lcpsolver/`  | 6     | High          | Low      |
| `dart/optimizer/`  | 8     | Low           | Medium   |
| `dart/io/`         | 3     | Medium        | Medium   |
| `dart/sensor/`     | 5     | Low           | Low      |

### 3. Disabled Tests Analysis

| Test                                          | Location          | Status      | Reason                                       |
| --------------------------------------------- | ----------------- | ----------- | -------------------------------------------- |
| `ClonedWorldsStayDeterministic`               | test_Issue410.cpp | **ENABLED** | Valid regression test                        |
| `ContactsReportNonZeroForceWithLargeTimeStep` | test_Issue410.cpp | **ENABLED** | Valid physics test                           |
| `CoMJacobianSignConsistency`                  | test_Joints.cpp   | **ENABLED** | Valid kinematic test                         |
| `HierarchicalTransforms`                      | test_frame.cpp    | DISABLED    | Requires Phase 2 experimental implementation |

### 4. Coverage Noise Sources

| Source                            | Action                | Rationale        |
| --------------------------------- | --------------------- | ---------------- |
| `.pixi/envs/` headers             | Filter from lcov      | Third-party code |
| `dart/gui/**`                     | Already excluded      | Requires display |
| `dart/simulation/experimental/**` | Already excluded      | Unstable API     |
| `examples/**`                     | Add to codecov ignore | Demo code        |
| `**/ikfast*.cpp`                  | Add to codecov ignore | Generated code   |

## Immediate Next Steps

### Phase 2: Fix Coverage Infrastructure (1-2 days)

1. **Fix lcov filter** in `pixi.toml`:

   ```bash
   lcov --remove coverage.info \
       '/usr/*' \
       '*/.pixi/*' \           # ADD THIS
       '*/.deps/*' \
       '*/tests/*' \
       '*/examples/*' \
       '*/tutorials/*' \
       --output-file coverage.info
   ```

2. **Update codecov.yml**:
   - Add `examples/**` to ignore
   - Add `**/ikfast*.cpp` to ignore
   - Add gcov parser configuration for branch detection
   - Add component tracking for per-module visibility

3. **Regenerate coverage** and verify numbers are accurate.

### Phase 3: Coverage Gap Analysis (3-5 days)

After fixing infrastructure:

1. Generate accurate coverage report
2. Identify top 10 under-covered files in core modules
3. Categorize gaps: easy wins vs complex areas
4. Create prioritized test backlog

### Phase 4: Test Implementation (1-2 weeks)

Focus areas (by ROI):

1. **Error paths** - Most under-tested, highest bug density
2. **Edge cases** - Boundary conditions, empty inputs
3. **Constraint solver** - Complex but critical
4. **Collision detection** - Multiple backends need parity testing

## Non-Goals

- 100% coverage (diminishing returns)
- Testing GUI code in CI (requires display)
- Testing experimental APIs (unstable)
- Trivial getter/setter tests

## Key Decisions

| Decision                  | Rationale                                     |
| ------------------------- | --------------------------------------------- |
| 80% target (not 85%)      | More realistic near-term; 85% is stretch goal |
| Focus on behavioral tests | Line coverage is a proxy, not the goal        |
| Exclude GUI from metrics  | Cannot test headless reliably                 |
| Per-module thresholds     | Different modules have different testability  |

## Success Criteria

| Metric                | Current | Target | Stretch |
| --------------------- | ------- | ------ | ------- |
| Overall line coverage | ~67%    | 80%    | 85%     |
| Core module coverage  | ~69%    | 82%    | 87%     |
| CI runtime            | ~10min  | <12min | <10min  |
| Flaky test rate       | Unknown | <1%    | 0%      |

## Related Files

- `codecov.yml` - Coverage configuration
- `pixi.toml` - Coverage report generation (line 789)
- `cmake/dart_defs.cmake` - gcovr targets (line 413)
- `tests/helpers/` - Shared test utilities
