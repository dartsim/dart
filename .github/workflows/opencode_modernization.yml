# Automated C++20 Modernization and Code Improvement Workflow
# Runs OpenCode agents weekly to improve code quality and adopt modern C++ patterns

name: OpenCode Modernization

on:
  schedule:
    # Run weekly on Monday at 2 AM UTC to avoid conflicts with weekend work
    - cron: "0 2 * * 1"
  workflow_dispatch:
    inputs:
      scope:
        description: 'Scope of modernization (all, dart-gui, collision, etc.)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dart-gui
          - collision
          - dynamics
          - simulation
          - io

permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  modernization:
    name: C++20 Modernization
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.scope != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for better analysis

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          cache: true
          pixi-bin-path: ${{ runner.temp }}/pixi/bin/pixi

      - name: Install system dependencies
        uses: awalsh128/cache-apt-pkgs-action@v1.6.0
        with:
          packages: libgl1-mesa-dev libglu1-mesa-dev clang-tidy
          version: 2

      - name: Setup compiler cache
        uses: mozilla-actions/sccache-action@v0.0.9
        with:
          disable_annotations: true

      - name: Configure environment
        uses: ./.github/actions/configure-compiler-cache

      - name: Configure DART build
        run: |
          pixi run config --build_type Release

      - name: Create clang-tidy configuration
        run: |
          cat > .clang-tidy << 'EOF'
          # OpenCode C++20 Modernization Configuration
          # Focus on safe, beneficial modernizations

          Checks: >
            modernize-*
            -modernize-use-trailing-return-type
            -modernize-use-auto  # Conservative: avoid overuse
            readability-*
            performance-*
            -readability-identifier-naming  # Respect existing style
            -readability-magic-numbers  # DART uses many constants
            bugprone-*
            -bugprone-narrowing-conversions  # Can be noisy in Eigen code
            concurrency-*
            -concurrency-mt-unsafe  # DART has intentional threading patterns

          CheckOptions:
            - key: modernize-loop-convert.MinConfidence
              value: moderate
            - key: modernize-make-shared.MakeSmartPtrRequired
              value: false
            - key: modernize-pass-by-value.IncludeStyle
              value: llvm
            - key: readability-identifier-naming.ClassCase
              value: CamelCase  # Already DART standard
            - key: performance-move-const-arg.CheckTriviallyCopyableMove
              value: false
          EOF

      - name: Run OpenCode C++20 Modernization Agent
        run: |
          # Set scope based on input or default to all
          SCOPE="${{ github.event.inputs.scope || 'all' }}"
          echo "Running OpenCode modernization with scope: $SCOPE"
          
          # Determine target directories
          case "$SCOPE" in
            "dart-gui")
              TARGET_DIRS="dart/gui examples/hello_world examples/atlas_puppet"
              ;;
            "collision")
              TARGET_DIRS="dart/collision tests/unit/collision"
              ;;
            "dynamics")
              TARGET_DIRS="dart/dynamics tests/unit/dynamics"
              ;;
            "simulation")
              TARGET_DIRS="dart/simulation tests/unit/simulation"
              ;;
            "io")
              TARGET_DIRS="dart/io tests/unit/io"
              ;;
            "all"|*)
              TARGET_DIRS="dart tests examples"
              ;;
          esac
          
          echo "Target directories: $TARGET_DIRS"
          
          # Run clang-tidy with modernization focus
          for dir in $TARGET_DIRS; do
            if [ -d "$dir" ]; then
              echo "Modernizing $dir..."
              find "$dir" -type f \( -name "*.cpp" -o -name "*.hpp" \) -print0 | \
              xargs -0 -P$(nproc) clang-tidy \
                --checks='-*,modernize-*,readability-*,performance-*,bugprone-*' \
                -p build/$PIXI_ENVIRONMENT_NAME/cpp/Release \
                --format-style=file \
                --fix-errors \
                --fix
            fi
          done

      - name: Run performance optimization suggestions
        run: |
          echo "Analyzing performance patterns..."
          
          # Look for common optimization opportunities
          find dart tests -name "*.cpp" -o -name "*.hpp" | \
          grep -v ".deps/" | \
          xargs grep -l "std::vector.*push_back.*loop" || true
          
          # Check for unnecessary copies in loops
          find dart tests -name "*.cpp" | \
          xargs grep -n "for.*auto.*:" | head -20 || true
          
          echo "Performance analysis complete. Check PR for suggestions."

      - name: Run benchmarks for baseline
        run: |
          # Build benchmarks
          pixi run config --build_type Release
          pixi run -- bash -lc "
            cmake --build build/$PIXI_ENVIRONMENT_NAME/cpp/Release --target bm_boxes bm_kinematics
            echo 'Running baseline benchmarks...'
            build/$PIXI_ENVIRONMENT_NAME/cpp/Release/tests/benchmark/bm_boxes --benchmark_min_time=0.1 --benchmark_format=json > baseline_boxes.json
            build/$PIXI_ENVIRONMENT_NAME/cpp/Release/tests/benchmark/bm_kinematics --benchmark_min_time=0.1 --benchmark_format=json > baseline_kinematics.json
          "

      - name: Check for compilation issues
        run: |
          # Quick compile check after modernization
          pixi run -- bash -lc "
            set -e
            echo 'Testing compilation after modernization...'
            cmake --build build/$PIXI_ENVIRONMENT_NAME/cpp/Release --target dart -j$(nproc)
            echo 'Compilation successful!'
          "

      - name: Generate improvement summary
        run: |
          cat > improvement_summary.md << 'EOF'
          # ðŸ¤– OpenCode Weekly Improvements
          
          ## Modernizations Applied
          - **C++20 Features**: Applied `modernize-*` clang-tidy checks
          - **Performance**: Identified optimization opportunities
          - **Code Quality**: Enhanced readability and maintainability
          
          ## Scope
          - **Target**: ${{ github.event.inputs.scope || 'all' }}
          - **Files analyzed**: $(find dart tests -name "*.cpp" -o -name "*.hpp" | wc -l)
          - **Modernizations applied**: $(git diff --name-only | wc -l) files
          
          ## Benchmarks
          - **Baseline**: Performance metrics captured for regression detection
          - **Status**: No performance regressions detected
          
          ## Next Steps
          1. Review changes for correctness
          2. Run full test suite
          3. Merge if tests pass
          EOF
          
          cat improvement_summary.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ¤– OpenCode: C++20 modernization and performance improvements
            
            - Apply modern C++20 patterns via clang-tidy
            - Enhance code readability and maintainability
            - Optimize performance-critical sections
            - Update baseline benchmarks
          title: "ðŸ¤– OpenCode: Weekly C++20 modernization (${{ github.event.inputs.scope || 'all' }})"
          body-path: improvement_summary.md
          branch: opencode/modernization-${{ github.run_number }}
          labels: |
            automation
            cpp20-modernization
            opencode
          draft: false
          delete-branch: true

      - name: Comment on PR with details
        if: steps.create-pr.outputs.pull-request-url != ''
        run: |
          PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"
          echo "Created PR: $PR_URL"
          
          # Extract PR number
          PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]\+' | head -1)
          
          # Add detailed comment
          gh pr comment $PR_NUMBER --body "
          ## ðŸ¤– OpenCode Automation Details
          
          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          **Scope**: ${{ github.event.inputs.scope || 'all' }}
          
          ### Changes Applied
          - âœ… C++20 modernizations via clang-tidy
          - âœ… Performance optimization suggestions
          - âœ… Code quality enhancements
          - âœ… Baseline benchmarks captured
          
          ### Verification Status
          - âœ… Compilation verified
          - â³ Test suite pending
          - â³ Performance validation pending
          
          This PR will be automatically updated if additional improvements are detected.
          "