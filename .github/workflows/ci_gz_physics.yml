name: CI gz-physics

on:
  push:
    branches:
      - "**"
    paths-ignore:
      - ".github/workflows/cache_*.yml"
      - "docker/dev/**"
  pull_request:
    branches:
      - "**"
    paths-ignore:
      - ".github/workflows/cache_*.yml"
      - "docker/dev/**"
  schedule:
    - cron: "0 2 * * 0,3"
  workflow_dispatch:

jobs:
  gz-physics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.8.14
        with:
          cache: true

      - uses: awalsh128/cache-apt-pkgs-action@v1.5.1
        with:
          packages: >-
            cmake
            build-essential
            git
            libbenchmark-dev
            libbullet-dev
            libeigen3-dev
            libgz-cmake4-dev
            libgz-common6-dev
            libgz-math8-dev
            libgz-plugin3-dev
            libgz-utils3-dev
            libsdformat15-dev
          version: 1.0

      - name: Build and install DART
        run: |
          DART_VERBOSE=ON \
          BUILD_TYPE=Release \
          pixi run install

      - name: Build gz-physics
        run: |
          git clone https://github.com/gazebosim/gz-physics.git
          cd gz-physics
          git checkout gz-physics8
          mkdir build && cd build
          cmake .. -DCMAKE_PREFIX_PATH=$CONDA_PREFIX -DBUILD_TESTING=ON
          cmake --build . -j$(nproc)
          ctest --output-on-failure
